<!DOCTYPE html>
<html>
    <head>
        <title>DQL User Defined Functions - Object Relational Mapper (ORM) - Doctrine</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="Doctrine Object Relational Mapper Documentation: DQL User Defined Functions ">

        <meta name="keywords" content="php,orm,mysql,object,data,mapper,mapping,query,dql,documentation,dql,user,defined,functions">

                    <meta name="robots" content="index, follow">
        
                    <link rel="canonical" href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.6/cookbook/dql-user-defined-functions.html" />
    
        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/index.css?176a03"
                        integrity="sha384-/l4d7PodUVDQz79xhGh8ALD2nKjjV7uqKdln6dx5HY4RAA/QYIlom3utgM+5M+hT"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/projects/doctrine-orm/en/2.5/cookbook/dql-user-defined-functions.html" />
        <meta property="og:title" content="DQL User Defined Functions - Object Relational Mapper (ORM) - Doctrine" />
        <meta property="og:description" content="Doctrine Object Relational Mapper Documentation: DQL User Defined Functions " />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

                    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Course",
            "name": "Doctrine Object Relational Mapper",
            "description": "DQL User Defined Functions",
            "provider": {
                "@type": "Organization",
                "name": "Doctrine",
                "sameAs": "https://www.doctrine-project.org"
            }
        }
        </script>
    
        
            </head>
    <body>
                    
            <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://www.doctrine-project.org/images/doctrine-logo.svg?6c0dab" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/reflection.html">Reflection</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/rst-parser.html">RST Parser</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/skeleton-mapper.html">Skeleton Mapper</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/community/index.html">Community</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                       <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/team/maintainers.html" id="navbarTeamDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Team</a>

                            <div class="dropdown-menu" aria-labelledby="navbarTeamDropdown">
                                <a class="dropdown-item" href="/team/maintainers.html">Maintainers</a>
                                <a class="dropdown-item" href="/team/contributors.html">Contributors</a>
                            </div>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/orm/edit/2.5/docs/en/cookbook/dql-user-defined-functions.rst" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <div class="container-wrapper container">
        <div class="row row-offcanvas row-offcanvas-right">
                            <nav class="col-md-3 d-sm-block bg-light sidebar sidebar-offcanvas" id="sidebar">
                    <div class="sidebar-sticky">
                        <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>

                        
<div class="toc"><ul><li id="advanced-field-value-conversion-using-custom-mapping-types-html-advanced-field-value-conversion-using-custom-mapping-types" class="toc-item"><a href="advanced-field-value-conversion-using-custom-mapping-types.html#advanced-field-value-conversion-using-custom-mapping-types">Advanced field value conversion using custom mapping types</a></li><ul><li id="advanced-field-value-conversion-using-custom-mapping-types-html-the-entity" class="toc-item"><a href="advanced-field-value-conversion-using-custom-mapping-types.html#the-entity">The entity</a></li><li id="advanced-field-value-conversion-using-custom-mapping-types-html-the-mapping-type" class="toc-item"><a href="advanced-field-value-conversion-using-custom-mapping-types.html#the-mapping-type">The mapping type</a></li><li id="advanced-field-value-conversion-using-custom-mapping-types-html-example-usage" class="toc-item"><a href="advanced-field-value-conversion-using-custom-mapping-types.html#example-usage">Example usage</a></li></ul><li id="aggregate-fields-html-aggregate-fields" class="toc-item"><a href="aggregate-fields.html#aggregate-fields">Aggregate Fields</a></li><ul><li id="aggregate-fields-html-an-example-model" class="toc-item"><a href="aggregate-fields.html#an-example-model">An example model</a></li><li id="aggregate-fields-html-using-dql" class="toc-item"><a href="aggregate-fields.html#using-dql">Using DQL</a></li><li id="aggregate-fields-html-using-your-domain-model" class="toc-item"><a href="aggregate-fields.html#using-your-domain-model">Using your Domain Model</a></li><li id="aggregate-fields-html-using-an-aggregate-field" class="toc-item"><a href="aggregate-fields.html#using-an-aggregate-field">Using an Aggregate Field</a></li><li id="aggregate-fields-html-tackling-race-conditions-with-aggregate-fields" class="toc-item"><a href="aggregate-fields.html#tackling-race-conditions-with-aggregate-fields">Tackling Race Conditions with Aggregate Fields</a></li><li id="aggregate-fields-html-keeping-updates-and-deletes-in-sync" class="toc-item"><a href="aggregate-fields.html#keeping-updates-and-deletes-in-sync">Keeping Updates and Deletes in Sync</a></li><li id="aggregate-fields-html-conclusion" class="toc-item"><a href="aggregate-fields.html#conclusion">Conclusion</a></li></ul><li id="custom-mapping-types-html-custom-mapping-types" class="toc-item"><a href="custom-mapping-types.html#custom-mapping-types">Custom Mapping Types</a></li><li id="decorator-pattern-html-persisting-the-decorator-pattern" class="toc-item"><a href="decorator-pattern.html#persisting-the-decorator-pattern">Persisting the Decorator Pattern</a></li><ul><li id="decorator-pattern-html-component" class="toc-item"><a href="decorator-pattern.html#component">Component</a></li><li id="decorator-pattern-html-concretecomponent" class="toc-item"><a href="decorator-pattern.html#concretecomponent">ConcreteComponent</a></li><li id="decorator-pattern-html-decorator" class="toc-item"><a href="decorator-pattern.html#decorator">Decorator</a></li><li id="decorator-pattern-html-concretedecorator" class="toc-item"><a href="decorator-pattern.html#concretedecorator">ConcreteDecorator</a></li><li id="decorator-pattern-html-examples" class="toc-item"><a href="decorator-pattern.html#examples">Examples</a></li></ul><li id="dql-custom-walkers-html-extending-dql-in-doctrine-2-custom-ast-walkers" class="toc-item"><a href="dql-custom-walkers.html#extending-dql-in-doctrine-2-custom-ast-walkers">Extending DQL in Doctrine 2: Custom AST Walkers</a></li><ul><li id="dql-custom-walkers-html-generic-count-query-for-pagination" class="toc-item"><a href="dql-custom-walkers.html#generic-count-query-for-pagination">Generic count query for pagination</a></li><li id="dql-custom-walkers-html-modify-the-output-walker-to-generate-vendor-specific-sql" class="toc-item"><a href="dql-custom-walkers.html#modify-the-output-walker-to-generate-vendor-specific-sql">Modify the Output Walker to generate Vendor specific SQL</a></li></ul><li id="dql-user-defined-functions-html-dql-user-defined-functions" class="toc-item"><a href="dql-user-defined-functions.html#dql-user-defined-functions">DQL User Defined Functions</a></li><ul><li id="dql-user-defined-functions-html-registering-your-own-dql-functions" class="toc-item"><a href="dql-user-defined-functions.html#registering-your-own-dql-functions">Registering your own DQL functions</a></li><li id="dql-user-defined-functions-html-date-diff" class="toc-item"><a href="dql-user-defined-functions.html#date-diff">Date Diff</a></li><li id="dql-user-defined-functions-html-date-add" class="toc-item"><a href="dql-user-defined-functions.html#date-add">Date Add</a></li><li id="dql-user-defined-functions-html-conclusion" class="toc-item"><a href="dql-user-defined-functions.html#conclusion">Conclusion</a></li></ul><li id="entities-in-session-html-entities-in-the-session" class="toc-item"><a href="entities-in-session.html#entities-in-the-session">Entities in the Session</a></li><ul><li id="entities-in-session-html-merging-entity-into-an-entitymanager" class="toc-item"><a href="entities-in-session.html#merging-entity-into-an-entitymanager">Merging entity into an EntityManager</a></li><li id="entities-in-session-html-serializing-entity-into-the-session" class="toc-item"><a href="entities-in-session.html#serializing-entity-into-the-session">Serializing entity into the session</a></li></ul><li id="implementing-arrayaccess-for-domain-objects-html-implementing-arrayaccess-for-domain-objects" class="toc-item"><a href="implementing-arrayaccess-for-domain-objects.html#implementing-arrayaccess-for-domain-objects">Implementing ArrayAccess for Domain Objects</a></li><ul><li id="implementing-arrayaccess-for-domain-objects-html-option-1" class="toc-item"><a href="implementing-arrayaccess-for-domain-objects.html#option-1">Option 1</a></li><li id="implementing-arrayaccess-for-domain-objects-html-option-2" class="toc-item"><a href="implementing-arrayaccess-for-domain-objects.html#option-2">Option 2</a></li><li id="implementing-arrayaccess-for-domain-objects-html-read-only" class="toc-item"><a href="implementing-arrayaccess-for-domain-objects.html#read-only">Read-only</a></li></ul><li id="implementing-the-notify-changetracking-policy-html-implementing-the-notify-changetracking-policy" class="toc-item"><a href="implementing-the-notify-changetracking-policy.html#implementing-the-notify-changetracking-policy">Implementing the Notify ChangeTracking Policy</a></li><ul><li id="implementing-the-notify-changetracking-policy-html-implementing-notifypropertychanged" class="toc-item"><a href="implementing-the-notify-changetracking-policy.html#implementing-notifypropertychanged">Implementing NotifyPropertyChanged</a></li></ul><li id="implementing-wakeup-or-clone-html-implementing-wakeup-or-clone" class="toc-item"><a href="implementing-wakeup-or-clone.html#implementing-wakeup-or-clone">Implementing Wakeup or Clone</a></li><ul><li id="implementing-wakeup-or-clone-html-safely-implementing-wakeup" class="toc-item"><a href="implementing-wakeup-or-clone.html#safely-implementing-wakeup">Safely implementing \_\_wakeup</a></li><li id="implementing-wakeup-or-clone-html-safely-implementing-clone" class="toc-item"><a href="implementing-wakeup-or-clone.html#safely-implementing-clone">Safely implementing \_\_clone</a></li><li id="implementing-wakeup-or-clone-html-summary" class="toc-item"><a href="implementing-wakeup-or-clone.html#summary">Summary</a></li></ul><li id="integrating-with-codeigniter-html-integrating-with-codeigniter" class="toc-item"><a href="integrating-with-codeigniter.html#integrating-with-codeigniter">Integrating with CodeIgniter</a></li><ul><li id="integrating-with-codeigniter-html-setting-up-the-file-structure" class="toc-item"><a href="integrating-with-codeigniter.html#setting-up-the-file-structure">Setting up the file structure</a></li><li id="integrating-with-codeigniter-html-creating-your-doctrine-codeigniter-library" class="toc-item"><a href="integrating-with-codeigniter.html#creating-your-doctrine-codeigniter-library">Creating your Doctrine CodeIgniter library</a></li><li id="integrating-with-codeigniter-html-now-to-use-it" class="toc-item"><a href="integrating-with-codeigniter.html#now-to-use-it">Now to use it</a></li></ul><li id="mysql-enums-html-mysql-enums" class="toc-item"><a href="mysql-enums.html#mysql-enums">Mysql Enums</a></li><ul><li id="mysql-enums-html-solution-1-mapping-to-varchars" class="toc-item"><a href="mysql-enums.html#solution-1-mapping-to-varchars">Solution 1: Mapping to Varchars</a></li><li id="mysql-enums-html-solution-2-defining-a-type" class="toc-item"><a href="mysql-enums.html#solution-2-defining-a-type">Solution 2: Defining a Type</a></li></ul><li id="resolve-target-entity-listener-html-keeping-your-modules-independent" class="toc-item"><a href="resolve-target-entity-listener.html#keeping-your-modules-independent">Keeping your Modules independent</a></li><ul><li id="resolve-target-entity-listener-html-background" class="toc-item"><a href="resolve-target-entity-listener.html#background">Background</a></li><li id="resolve-target-entity-listener-html-set-up" class="toc-item"><a href="resolve-target-entity-listener.html#set-up">Set up</a></li><li id="resolve-target-entity-listener-html-final-thoughts" class="toc-item"><a href="resolve-target-entity-listener.html#final-thoughts">Final Thoughts</a></li></ul><li id="sql-table-prefixes-html-sql-table-prefixes" class="toc-item"><a href="sql-table-prefixes.html#sql-table-prefixes">SQL-Table Prefixes</a></li><ul><li id="sql-table-prefixes-html-implementing-the-listener" class="toc-item"><a href="sql-table-prefixes.html#implementing-the-listener">Implementing the listener</a></li><li id="sql-table-prefixes-html-telling-the-entitymanager-about-our-listener" class="toc-item"><a href="sql-table-prefixes.html#telling-the-entitymanager-about-our-listener">Telling the EntityManager about our listener</a></li></ul><li id="strategy-cookbook-introduction-html-strategy-pattern" class="toc-item"><a href="strategy-cookbook-introduction.html#strategy-pattern">Strategy-Pattern</a></li><ul><li id="strategy-cookbook-introduction-html-scenario-problem" class="toc-item"><a href="strategy-cookbook-introduction.html#scenario-problem">Scenario / Problem</a></li><li id="strategy-cookbook-introduction-html-solution" class="toc-item"><a href="strategy-cookbook-introduction.html#solution">Solution</a></li></ul><li id="validation-of-entities-html-validation-of-entities" class="toc-item"><a href="validation-of-entities.html#validation-of-entities">Validation of Entities</a></li><li id="working-with-datetime-html-working-with-datetime-instances" class="toc-item"><a href="working-with-datetime.html#working-with-datetime-instances">Working with DateTime Instances</a></li><ul><li id="working-with-datetime-html-datetime-changes-are-detected-by-reference" class="toc-item"><a href="working-with-datetime.html#datetime-changes-are-detected-by-reference">DateTime changes are detected by Reference</a></li><li id="working-with-datetime-html-default-timezone-gotcha" class="toc-item"><a href="working-with-datetime.html#default-timezone-gotcha">Default Timezone Gotcha</a></li><li id="working-with-datetime-html-handling-different-timezones-with-the-datetime-type" class="toc-item"><a href="working-with-datetime.html#handling-different-timezones-with-the-datetime-type">Handling different Timezones with the DateTime Type</a></li></ul></ul></div>
                    </div>
                </nav>
            
            <main role="main" class="col-md-9 ml-sm-auto col-lg-9 pt-3 px-4">
                <div class="row">
                                        
                                                                <nav class="breadcrumbs d-none d-sm-block d-md-block d-lg-block d-xl-block" aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="https://www.doctrine-project.org/projects.html">Projects</a></li>
                                <li class="breadcrumb-item"><a href="https://www.doctrine-project.org/projects/orm.html">ORM</a></li>
                                <li class="breadcrumb-item"><a href="https://www.doctrine-project.org/projects/doctrine-orm/en/2.5/">Documentation</a></li>
                                <li class="breadcrumb-item active" aria-current="page">DQL User Defined Functions</li>
                            </ol>
                        </nav>
                                    </div>

                    
    <div class="alert caution bg-light-yellow text-dark border">
    <table width="100%">
        <tr>
            <td width="10" class="align-top">
                <i class="fas fa-exclamation-circle text-warning mr-2"></i>
            </td>
            <td><p>You are browsing a version that is no longer maintained.</p></td>
        </tr>
    </table>
</div>

                <div class="row">
                    <div class="col-12">
                                                    <button type="button" class="btn btn-primary btn-sm float-right toc-toggle" data-toggle="offcanvas" id="toc-toggle">Table of Contents</button>

                                                            
                                <div class="dropdown show d-inline-block">
                                    <a class="project-version-switcher btn btn-secondary btn-sm dropdown-toggle" href="/projects/doctrine-orm/en/2.5/cookbook/dql-user-defined-functions.html" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        2.5
                                    </a>

                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                                                    <h6 class="dropdown-header">Maintained</h6>

                                                                                            
                                                <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/latest/cookbook/dql-user-defined-functions.html">
                                                    3.0

                                                    
                                                                                                            (upcoming)
                                                                                                    </a>
                                                                                            
                                                <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.7/cookbook/dql-user-defined-functions.html">
                                                    2.7

                                                    
                                                                                                            (upcoming)
                                                                                                    </a>
                                                                                            
                                                <a class="project-version-switcher dropdown-item" href="/projects/doctrine-orm/en/2.6/cookbook/dql-user-defined-functions.html">
                                                    2.6

                                                                                                            (current)
                                                    
                                                                                                    </a>
                                                                                    
                                                                                    <h6 class="dropdown-header">Unmaintained</h6>

                                                                                            
                                                <a class="dropdown-item active" href="/projects/doctrine-orm/en/2.5/cookbook/dql-user-defined-functions.html">2.5</a>
                                                                                            
                                                <a class="dropdown-item" href="/projects/doctrine-orm/en/2.4/cookbook/dql-user-defined-functions.html">2.4</a>
                                                                                                                        </div>
                                </div>
                            
                            
<p></p>
<a class="section-anchor" id="dql-user-defined-functions" name="dql-user-defined-functions"></a><h1 class="section-header"><a href="#dql-user-defined-functions">DQL User Defined Functions<i class="fas fa-link"></i></a></h1>
<div class="alert section-author bg-light text-dark border"><p class="author font-weight-bold"><i class="fas fa-pencil-alt"></i> Written by <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a></p></div>
<p>It is worth to mention that Doctrine 2 also allows you to handwrite
your SQL instead of extending the DQL parser. Extending DQL is sort of an
advanced extension point. You can map arbitrary SQL to your objects
and gain access to vendor specific functionalities using the
<code>EntityManager#createNativeQuery()</code> API as described in
the <a href="../reference/native-sql.html">Native Query</a> chapter.</p>
<p>The DQL Parser has hooks to register functions that can then be
used in your DQL queries and transformed into SQL, allowing to
extend Doctrines Query capabilities to the vendors strength. This
post explains the Used-Defined Functions API (UDF) of the Dql
Parser and shows some examples to give you some hints how you would
extend DQL.</p>
<p>There are three types of functions in DQL, those that return a
numerical value, those that return a string and those that return a
Date. Your custom method has to be registered as either one of
those. The return type information is used by the DQL parser to
check possible syntax errors during the parsing process, for
example using a string function return value in a math expression.</p>
<a class="section-anchor" id="registering-your-own-dql-functions" name="registering-your-own-dql-functions"></a><h2 class="section-header"><a href="#registering-your-own-dql-functions">Registering your own DQL functions<i class="fas fa-link"></i></a></h2>
<p>You can register your functions adding them to the ORM
configuration:</p>
<pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="bf1b761f3f4552b87757f2e2b577ab10fff929bd"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="bf1b761f3f4552b87757f2e2b577ab10fff929bd"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-1" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-1">1</a></td><td class="code-line" rowspan="7"><span class="hljs-meta">&lt;?php</span>
$config = <span class="hljs-keyword">new</span> \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction($name, $class);
$config-&gt;addCustomNumericFunction($name, $class);
$config-&gt;addCustomDatetimeFunction($name, $class);

$em = EntityManager::create($dbParams, $config);</td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-2" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-3" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-4" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-5" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-6" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-7" class="line-number-anchor" /><a href="#line-number-bf1b761f3f4552b87757f2e2b577ab10fff929bd-7">7</a></td></tr></table></div></code></pre>
<p>The <code>$name</code> is the name the function will be referred to in the
DQL query. <code>$class</code> is a string of a class-name which has to
extend <code>Doctrine\ORM\Query\Node\FunctionNode</code>. This is a class
that offers all the necessary API and methods to implement a UDF.</p>
<p>Instead of providing the function class name, you can also provide
a callable that returns the function object:</p>
<pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="099a7f3b4995178133898f96bf4a23a70f9d0b1a"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="099a7f3b4995178133898f96bf4a23a70f9d0b1a"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-1" class="line-number-anchor" /><a href="#line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-1">1</a></td><td class="code-line" rowspan="5"><span class="hljs-meta">&lt;?php</span>
$config = <span class="hljs-keyword">new</span> \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction($name, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyCustomFunction();
});</td></tr>
<tr><td class="line-number noselect"><a name="line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-2" class="line-number-anchor" /><a href="#line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-3" class="line-number-anchor" /><a href="#line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-4" class="line-number-anchor" /><a href="#line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-5" class="line-number-anchor" /><a href="#line-number-099a7f3b4995178133898f96bf4a23a70f9d0b1a-5">5</a></td></tr></table></div></code></pre>
<p>In this post we will implement some MySql specific Date calculation
methods, which are quite handy in my opinion:</p>
<a class="section-anchor" id="date-diff" name="date-diff"></a><h2 class="section-header"><a href="#date-diff">Date Diff<i class="fas fa-link"></i></a></h2>
<p><a href="http://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html#function_datediff">Mysql's DateDiff function</a>
takes two dates as argument and calculates the difference in days
with <code>date1-date2</code>.</p>
<p>The DQL parser is a top-down recursive descent parser to generate
the Abstract-Syntax Tree (AST) and uses a TreeWalker approach to
generate the appropriate SQL from the AST. This makes reading the
Parser/TreeWalker code manageable in a finite amount of time.</p>
<p>The <code>FunctionNode</code> class I referred to earlier requires you to
implement two methods, one for the parsing process (obviously)
called <code>parse</code> and one for the TreeWalker process called
<code>getSql()</code>. I show you the code for the DateDiff method and
discuss it step by step:</p>
<pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="8cdea236d9ad5678de97da5b413d49239ac2a339"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="8cdea236d9ad5678de97da5b413d49239ac2a339"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-1" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-1">1</a></td><td class="code-line" rowspan="28"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/**
 * DateDiffFunction ::= "DATEDIFF" "(" ArithmeticPrimary "," ArithmeticPrimary ")"
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateDiff</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FunctionNode</span>
</span>{
    <span class="hljs-comment">// (1)</span>
    <span class="hljs-keyword">public</span> $firstDateExpression = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">public</span> $secondDateExpression = <span class="hljs-keyword">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span><span class="hljs-params">(\Doctrine\ORM\Query\Parser $parser)</span>
    </span>{
        $parser-&gt;match(Lexer::T_IDENTIFIER); <span class="hljs-comment">// (2)</span>
        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS); <span class="hljs-comment">// (3)</span>
        <span class="hljs-keyword">$this</span>-&gt;firstDateExpression = $parser-&gt;ArithmeticPrimary(); <span class="hljs-comment">// (4)</span>
        $parser-&gt;match(Lexer::T_COMMA); <span class="hljs-comment">// (5)</span>
        <span class="hljs-keyword">$this</span>-&gt;secondDateExpression = $parser-&gt;ArithmeticPrimary(); <span class="hljs-comment">// (6)</span>
        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS); <span class="hljs-comment">// (3)</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSql</span><span class="hljs-params">(\Doctrine\ORM\Query\SqlWalker $sqlWalker)</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'DATEDIFF('</span> .
            <span class="hljs-keyword">$this</span>-&gt;firstDateExpression-&gt;dispatch($sqlWalker) . <span class="hljs-string">', '</span> .
            <span class="hljs-keyword">$this</span>-&gt;secondDateExpression-&gt;dispatch($sqlWalker) .
        <span class="hljs-string">')'</span>; <span class="hljs-comment">// (7)</span>
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-2" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-3" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-4" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-5" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-6" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-7" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-8" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-9" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-10" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-11" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-12" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-13" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-14" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-15" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-16" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-17" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-18" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-19" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-20" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-21" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-22" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-23" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-24" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-25" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-25">25</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-26" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-26">26</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-27" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-27">27</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-28" class="line-number-anchor" /><a href="#line-number-8cdea236d9ad5678de97da5b413d49239ac2a339-28">28</a></td></tr></table></div></code></pre>
<p>The Parsing process of the DATEDIFF function is going to find two
expressions the date1 and the date2 values, whose AST Node
representations will be saved in the variables of the DateDiff
FunctionNode instance at (1).</p>
<p>The parse() method has to cut the function call &quot;DATEDIFF&quot; and its
argument into pieces. Since the parser detects the function using a
lookahead the T\_IDENTIFIER of the function name has to be taken
from the stack (2), followed by a detection of the arguments in
(4)-(6). The opening and closing parenthesis have to be detected
also. This happens during the Parsing process and leads to the
generation of a DateDiff FunctionNode somewhere in the AST of the
dql statement.</p>
<p>The <code>ArithmeticPrimary</code> method call is the most common
denominator of valid EBNF tokens taken from the
<a href="http://www.doctrine-project.org/documentation/manual/2_0/en/dql-doctrine-query-language#ebnf">DQL EBNF grammar</a>
that matches our requirements for valid input into the DateDiff Dql
function. Picking the right tokens for your methods is a tricky
business, but the EBNF grammar is pretty helpful finding it, as is
looking at the Parser source code.</p>
<p>Now in the TreeWalker process we have to pick up this node and
generate SQL from it, which apparently is quite easy looking at the
code in (7). Since we don't know which type of AST Node the first
and second Date expression are we are just dispatching them back to
the SQL Walker to generate SQL from and then wrap our DATEDIFF
function call around this output.</p>
<p>Now registering this DateDiff FunctionNode with the ORM using:</p>
<pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="91f9234031be947352344158a5aadff68a0fef13"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="91f9234031be947352344158a5aadff68a0fef13"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-91f9234031be947352344158a5aadff68a0fef13-1" class="line-number-anchor" /><a href="#line-number-91f9234031be947352344158a5aadff68a0fef13-1">1</a></td><td class="code-line" rowspan="3"><span class="hljs-meta">&lt;?php</span>
$config = <span class="hljs-keyword">new</span> \Doctrine\ORM\Configuration();
$config-&gt;addCustomStringFunction(<span class="hljs-string">'DATEDIFF'</span>, <span class="hljs-string">'DoctrineExtensions\Query\MySql\DateDiff'</span>);</td></tr>
<tr><td class="line-number noselect"><a name="line-number-91f9234031be947352344158a5aadff68a0fef13-2" class="line-number-anchor" /><a href="#line-number-91f9234031be947352344158a5aadff68a0fef13-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-91f9234031be947352344158a5aadff68a0fef13-3" class="line-number-anchor" /><a href="#line-number-91f9234031be947352344158a5aadff68a0fef13-3">3</a></td></tr></table></div></code></pre>
<p>We can do fancy stuff like:</p>
<pre class="code-block-table"><code class="sql"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="09aff150f64cc9ff9b8cc4e71a645d0c0222b65a"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="09aff150f64cc9ff9b8cc4e71a645d0c0222b65a"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-09aff150f64cc9ff9b8cc4e71a645d0c0222b65a-1" class="line-number-anchor" /><a href="#line-number-09aff150f64cc9ff9b8cc4e71a645d0c0222b65a-1">1</a></td><td class="code-line" rowspan="1"><span class="hljs-keyword">SELECT</span> p <span class="hljs-keyword">FROM</span> DoctrineExtensions\<span class="hljs-keyword">Query</span>\BlogPost p <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">DATEDIFF</span>(<span class="hljs-keyword">CURRENT_TIME</span>(), p.created) &lt; <span class="hljs-number">7</span></td></tr></table></div></code></pre>
<a class="section-anchor" id="date-add" name="date-add"></a><h2 class="section-header"><a href="#date-add">Date Add<i class="fas fa-link"></i></a></h2>
<p>Often useful it the ability to do some simple date calculations in
your DQL query using
<a href="http://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html#function_date-add">MySql's DATE\_ADD function</a>.</p>
<p>I'll skip the blah and show the code for this function:</p>
<pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-1" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-1">1</a></td><td class="code-line" rowspan="40"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">/**
 * DateAddFunction ::=
 *     "DATE_ADD" "(" ArithmeticPrimary ", INTERVAL" ArithmeticPrimary Identifier ")"
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateAdd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FunctionNode</span>
</span>{
    <span class="hljs-keyword">public</span> $firstDateExpression = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">public</span> $intervalExpression = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">public</span> $unit = <span class="hljs-keyword">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span><span class="hljs-params">(\Doctrine\ORM\Query\Parser $parser)</span>
    </span>{
        $parser-&gt;match(Lexer::T_IDENTIFIER);
        $parser-&gt;match(Lexer::T_OPEN_PARENTHESIS);

        <span class="hljs-keyword">$this</span>-&gt;firstDateExpression = $parser-&gt;ArithmeticPrimary();

        $parser-&gt;match(Lexer::T_COMMA);
        $parser-&gt;match(Lexer::T_IDENTIFIER);

        <span class="hljs-keyword">$this</span>-&gt;intervalExpression = $parser-&gt;ArithmeticPrimary();

        $parser-&gt;match(Lexer::T_IDENTIFIER);

        <span class="hljs-comment">/* <span class="hljs-doctag">@var</span> $lexer Lexer */</span>
        $lexer = $parser-&gt;getLexer();
        <span class="hljs-keyword">$this</span>-&gt;unit = $lexer-&gt;token[<span class="hljs-string">'value'</span>];

        $parser-&gt;match(Lexer::T_CLOSE_PARENTHESIS);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSql</span><span class="hljs-params">(\Doctrine\ORM\Query\SqlWalker $sqlWalker)</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'DATE_ADD('</span> .
            <span class="hljs-keyword">$this</span>-&gt;firstDateExpression-&gt;dispatch($sqlWalker) . <span class="hljs-string">', INTERVAL '</span> .
            <span class="hljs-keyword">$this</span>-&gt;intervalExpression-&gt;dispatch($sqlWalker) . <span class="hljs-string">' '</span> . <span class="hljs-keyword">$this</span>-&gt;unit .
        <span class="hljs-string">')'</span>;
    }
}</td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-2" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-3" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-4" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-5" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-6" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-7" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-8" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-9" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-10" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-11" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-12" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-13" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-14" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-15" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-16" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-17" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-18" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-19" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-20" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-21" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-22" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-23" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-24" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-25" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-25">25</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-26" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-26">26</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-27" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-27">27</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-28" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-28">28</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-29" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-29">29</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-30" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-30">30</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-31" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-31">31</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-32" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-32">32</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-33" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-33">33</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-34" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-34">34</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-35" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-35">35</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-36" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-36">36</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-37" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-37">37</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-38" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-38">38</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-39" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-39">39</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-40" class="line-number-anchor" /><a href="#line-number-dccc7c687ca1ebfa5b5052e69c6ee01f4333edc2-40">40</a></td></tr></table></div></code></pre>
<p>The only difference compared to the DATEDIFF here is, we
additionally need the <code>Lexer</code> to access the value of the
<code>T_IDENTIFIER</code> token for the Date Interval unit, for example the
MONTH in:</p>
<pre class="code-block-table"><code class="sql"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="7dfa2ccf63a595570c4f6eafd25f3b9132cbe3d6"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="7dfa2ccf63a595570c4f6eafd25f3b9132cbe3d6"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-7dfa2ccf63a595570c4f6eafd25f3b9132cbe3d6-1" class="line-number-anchor" /><a href="#line-number-7dfa2ccf63a595570c4f6eafd25f3b9132cbe3d6-1">1</a></td><td class="code-line" rowspan="1"><span class="hljs-keyword">SELECT</span> p <span class="hljs-keyword">FROM</span> DoctrineExtensions\<span class="hljs-keyword">Query</span>\BlogPost p <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">DATE_ADD</span>(<span class="hljs-keyword">CURRENT_TIME</span>(), <span class="hljs-built_in">INTERVAL</span> <span class="hljs-number">4</span> <span class="hljs-keyword">MONTH</span>) &gt; p.created</td></tr></table></div></code></pre>
<p>The above method now only supports the specification using
<code>INTERVAL</code>, to also allow a real date in DATE\_ADD we need to add
some decision logic to the parsing process (makes up for a nice
exercise).</p>
<p>Now as you see, the Parsing process doesn't catch all the possible
SQL errors, here we don't match for all the valid inputs for the
interval unit. However where necessary we rely on the database
vendors SQL parser to show us further errors in the parsing
process, for example if the Unit would not be one of the supported
values by MySql.</p>
<a class="section-anchor" id="conclusion" name="conclusion"></a><h2 class="section-header"><a href="#conclusion">Conclusion<i class="fas fa-link"></i></a></h2>
<p>Now that you all know how you can implement vendor specific SQL
functionalities in DQL, we would be excited to see user extensions
that add vendor specific function packages, for example more math
functions, XML + GIS Support, Hashing functions and so on.</p>
<p>For 2.0 we will come with the current set of functions, however for
a future version we will re-evaluate if we can abstract even more
vendor sql functions and extend the DQL languages scope.</p>
<p>Code for this Extension to DQL and other Doctrine Extensions can be
found
<a href="http://github.com/beberlei/DoctrineExtensions">in my Github DoctrineExtensions repository</a>.</p>
<p></p>
                                            </div>
                </div>
            </main>
        </div>
    </div>

        <button id="back-to-top" title="Go to top">Top</button>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://www.doctrine-project.org/frontend/js/bundle.js?3aa944"
                            integrity="sha384-C3frOTowPU2u/UuMpJMJ9PW/WeWOGSQvjOY701yPq2o2KLmEpVyTVCTe5SlNGyCd"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = 'orm';
            var versionSlug = '2.5';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search ORM 2.5'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
            </body>
</html>
