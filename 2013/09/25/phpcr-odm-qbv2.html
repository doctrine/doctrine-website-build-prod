<!DOCTYPE html>
<html>
    <head>
        <title>PHPCR ODM QueryBuilder v2 - Doctrine: PHP Open Source Project</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
            <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://www.doctrine-project.org/2013/09/25/phpcr-odm-qbv2.html"
        },
        "headline": "PHPCR ODM QueryBuilder v2",
        "image": [
            "https://www.doctrine-project.org/images/og.png"
        ],
        "datePublished": "2013-09-25T00:00:00-04:00",
        "dateModified": "2013-09-25T00:00:00-04:00",
        "author": {
            "@type": "Person",
            "name": "dantleech"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Doctrine",
            "logo": {
                "@type": "ImageObject",
                "url": "https://www.doctrine-project.org/images/og.png"
            }
        },
        "description": "managed to merge the new query builder.

                
    I developed the original query builder"
    }
    </script>
    <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/prismjs.css?d2443b"
                            integrity="sha384-IcJ7eow//K0xRBscZjnk8kawYxbm2eUAZ9D6Xf/n0yuAi1NCvwOkep1S8XqPNB3E"
                        crossorigin="anonymous"
    />

        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/index.css?74d1a1"
                        integrity="sha384-dAaEn2ZyD87ZE8ZaTOc39tmNlPuZWU7Tvl3K1W/IXH5rtko68QAI5cdG6HLv97IH"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/2013/09/25/phpcr-odm-qbv2.html" />
        <meta property="og:title" content="PHPCR ODM QueryBuilder v2 - Doctrine: PHP Open Source Project" />
        <meta property="og:description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://www.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/sponsorship.html">Sponsorship</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/doctrine-website/edit/master/source/blog/2013-09-25-phpcr-odm-qbv2.md" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>
                </div>
                <div class="nav-outbound">
                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
            <article>
        <div class="row">
            <div class="col-lg-8 col-12">
                <header>
                    <h2>PHPCR ODM QueryBuilder v2</h2>
                </header>

                <p class="lead">
                    Posted on <date>September 25, 2013</date>
                                            by
                                                    dantleech
                                                            </p>
            </div>

            <div class="col-lg-4 col-12">
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>
            </div>
        </div>

        <hr />

        <div>
                
            
                
    <p>managed to merge the new query builder.</p>

                
    <p>I developed the original query builder about 9 months ago - it was one of my first contributions to the PHPCR-ODM doctrine project. It was heavily based on the ORM query builder and the consensus being that we should make the ODM as intuitive as possible for existing ORM users.</p>

                
    <p>Abstracting PHPCR to fit the existing interface worked up until a point, we could implement the <em>basic</em> functionality of the ORM Query Builder exactly, things started to come undone when we looked at implementing joins.</p>

                
    <p>I had added the joins in the API but didn&#039;t get around to implementing them, the methods just threw &quot;not implemented&quot; exceptions. Later, when we wanted to implement them, it wasn&#039;t so simple. Infact, upon closer inspection, many of the things available in the PHPCR API&#039;s Query Object Model interface were not covered by the model of the query builder we had chosen, in short, it was not fit for purpose. I expounded this on the following wiki page:</p>

                

<ul>
    <li class="dash"><a href="https://github.com/symfony-cmf/symfony-cmf/wiki/Query-Builder-v2">https://github.com/symfony-cmf/symfony-cmf/wiki/Query-Builder-v2</a></li>
</ul>

                
    <p>As detailed in the above linked page, it seemed to me that either we implemented a 2 part factory heavy query builder or a fluent node based query builder. The node based design won. However, at the time I never imagined it would take so long to write! So nearly 2 months later here we are.</p>

                
    <p>Some features of the new query builder</p>

                

<ul>
    <li class="dash">Can fully express the PHPCR QOM (Query Object Model).</li>
    <li class="dash">Features a fluent interface.</li>
    <li class="dash">Strict validation and helpful exception messages.</li>
    <li class="dash">Less verbose than the PHPCR QOM model.</li>
</ul>

                
    <p>Lets compare a PHPCR QOM query with its new query builder counterpart:</p>

                
    <p>The following two examples are equivalent and both select a blog posts with node name &quot;My Post Title&quot; having the ODM class &quot;BlogPost&quot;. We order the result set first by publishing date and then by title.</p>

                
    <p>Using the PHPCR QOM:</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-1" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-1">1</a></td><td class="code-line" rowspan="25"><span class="hljs-meta">&lt;?php</span>
$q = $qom-&gt;createQuery(
    <span class="hljs-comment">// SourceInterface (from)</span>
    $qom-&gt;selector(<span class="hljs-string">'nt:unstructured'</span>, <span class="hljs-string">'p'</span>)
    $qom-&gt;andConstraint(
        $qom-&gt;comparison(
            $qom-&gt;propertyValue(<span class="hljs-string">'p'</span>, <span class="hljs-string">'phpcr:class'</span>),
            $qom-&gt;bindVariableValue(<span class="hljs-string">'phpcr_class'</span>),
            QueryObjectModelInterface::JCR_OPERATOR_EQUAL_TO
        ),
        $qom-&gt;comparison(
            $qom-&gt;nodeLocalName(<span class="hljs-string">'p'</span>),
            $qom-&gt;bindVariableValue(<span class="hljs-string">'post_title'</span>),
            QueryObjectModelInterface::JCR_OPERATOR_EQUAL_TO
        ),
        <span class="hljs-keyword">array</span>(
            $qom-&gt;ascending($qom-&gt;propertyValue(<span class="hljs-string">'published_on'</span>, <span class="hljs-string">'p'</span>))
            $qom-&gt;ascending($qom-&gt;propertyValue(<span class="hljs-string">'title'</span>, <span class="hljs-string">'p'</span>))
        )
    )
);
$q-&gt;bindValue(<span class="hljs-string">'phpcr_class'</span>, <span class="hljs-string">'Blog\Post'</span>);
$q-&gt;bindValue(<span class="hljs-string">'post_title'</span>, <span class="hljs-string">'My Post Title'</span>);
$res = $q-&gt;execute();
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-2" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-3" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-4" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-5" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-6" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-7" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-8" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-9" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-10" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-11" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-12" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-13" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-14" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-15" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-16" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-16">16</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-17" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-17">17</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-18" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-18">18</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-19" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-19">19</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-20" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-20">20</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-21" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-21">21</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-22" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-22">22</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-23" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-23">23</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-24" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-24">24</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-25" class="line-number-anchor" /><a href="#line-number-71781ec1f168020fb7f26d0f71d09e7c0b6d2ebb-25">25</a></td></tr></table></div></code></pre>
                
    <p>Using the new PHPCR-ODM query builder:</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="0bec24f10ab72dae8c625e5246eba7cffc612748"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="0bec24f10ab72dae8c625e5246eba7cffc612748"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-1" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-1">1</a></td><td class="code-line" rowspan="14"><span class="hljs-meta">&lt;?php</span>
$q = $documentManager-&gt;createQueryBuilder()
    -&gt;fromDocument(<span class="hljs-string">'Blog\Post'</span>, <span class="hljs-string">'p'</span>)
    -&gt;where()
        -&gt;eq()-&gt;field(<span class="hljs-string">'p.title'</span>)-&gt;parameter(<span class="hljs-string">'post_title'</span>)-&gt;end()
    -&gt;end()
    -&gt;orderBy()
        -&gt;asc()-&gt;field(<span class="hljs-string">'p.published_on'</span>)-&gt;end()
        -&gt;asc()-&gt;field(<span class="hljs-string">'p.title'</span>)-&gt;end()
    -&gt;end()
    -&gt;setParameter(<span class="hljs-string">'post_title'</span>, <span class="hljs-string">'My Post Title'</span>)
    -&gt;getQuery();
$res = $q-&gt;execute();
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-2" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-3" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-4" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-5" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-6" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-7" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-8" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-9" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-10" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-11" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-12" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-13" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-14" class="line-number-anchor" /><a href="#line-number-0bec24f10ab72dae8c625e5246eba7cffc612748-14">14</a></td></tr></table></div></code></pre>
                
    <p>Whilst the two examples above are equivalent it should be noted that we are being slightly unfair to the PHPCR QOM as we are forced to add the <code>phpcr:class</code> constraint, which is a PHPCR-ODMism. Despite this, the new API is clearly less verbose and, I hope, more intelligible.</p>

                
    <p>The API allows chaining together operands:</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="36264faac9ba22653affcbc7d30da3ba62191c38"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="36264faac9ba22653affcbc7d30da3ba62191c38"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-1" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-1">1</a></td><td class="code-line" rowspan="16"><span class="hljs-meta">&lt;?php</span>
$qb = $documentManager-&gt;createQueryBuilder();
$qb
    -&gt;from()
        -&gt;document(<span class="hljs-string">'Blog\Post'</span>, <span class="hljs-string">'p'</span>)
    -&gt;end()
    -&gt;where()
        -&gt;andX()
            -&gt;orX()
                -&gt;eq()-&gt;upperCase()-&gt;field(<span class="hljs-string">'p.username'</span>)-&gt;end()-&gt;literal(<span class="hljs-string">'DANTLEECH'</span>)-&gt;end()
                -&gt;eq()-&gt;field(<span class="hljs-string">'c.initials'</span>)-&gt;literal(<span class="hljs-string">'dtl'</span>)-&gt;end()
            -&gt;end()
            -&gt;lte()-&gt;field(<span class="hljs-string">'p.published_on'</span>)-&gt;literal(<span class="hljs-string">'2013-09-14'</span>)-&gt;end()
        -&gt;end()
    -&gt;end();
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-2" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-3" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-4" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-5" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-6" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-7" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-8" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-9" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-9">9</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-10" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-10">10</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-11" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-11">11</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-12" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-12">12</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-13" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-13">13</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-14" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-14">14</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-15" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-15">15</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-36264faac9ba22653affcbc7d30da3ba62191c38-16" class="line-number-anchor" /><a href="#line-number-36264faac9ba22653affcbc7d30da3ba62191c38-16">16</a></td></tr></table></div></code></pre>
                
    <p>The API also allows you to break the query into multiple statements:</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="3aa1eccda30858691a6c29599e6422640e415195"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="3aa1eccda30858691a6c29599e6422640e415195"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-3aa1eccda30858691a6c29599e6422640e415195-1" class="line-number-anchor" /><a href="#line-number-3aa1eccda30858691a6c29599e6422640e415195-1">1</a></td><td class="code-line" rowspan="5"><span class="hljs-meta">&lt;?php</span>
$qb-&gt;from()-&gt;document(<span class="hljs-string">'Blog\Post'</span>, <span class="hljs-string">'p'</span>);
$qb-&gt;where()-&gt;eq()-&gt;field(<span class="hljs-string">'p.title'</span>)-&gt;literal(<span class="hljs-string">'Foobar'</span>);
$qb-&gt;orderBy()-&gt;asc()-&gt;field(<span class="hljs-string">'p.title'</span>);
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-3aa1eccda30858691a6c29599e6422640e415195-2" class="line-number-anchor" /><a href="#line-number-3aa1eccda30858691a6c29599e6422640e415195-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3aa1eccda30858691a6c29599e6422640e415195-3" class="line-number-anchor" /><a href="#line-number-3aa1eccda30858691a6c29599e6422640e415195-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3aa1eccda30858691a6c29599e6422640e415195-4" class="line-number-anchor" /><a href="#line-number-3aa1eccda30858691a6c29599e6422640e415195-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-3aa1eccda30858691a6c29599e6422640e415195-5" class="line-number-anchor" /><a href="#line-number-3aa1eccda30858691a6c29599e6422640e415195-5">5</a></td></tr></table></div></code></pre>
                
    <p>And to add extra criteria to an existing query builder instance (useful if the query builder is instantiated and initialized by a vendor library):</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="de82d0b2b4f82f4f90f9b54f70f1572820350158"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="de82d0b2b4f82f4f90f9b54f70f1572820350158"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-1" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-1">1</a></td><td class="code-line" rowspan="9"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyExtension</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modifyQuery</span><span class="hljs-params">(QueryBuilder $qb)</span>
    </span>{
        $qb-&gt;andWhere()-&gt;field(<span class="hljs-string">'f.site_id'</span>)-&gt;literal(<span class="hljs-number">1</span>);
    }
}
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-2" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-3" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-4" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-5" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-6" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-7" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-8" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-9" class="line-number-anchor" /><a href="#line-number-de82d0b2b4f82f4f90f9b54f70f1572820350158-9">9</a></td></tr></table></div></code></pre>
                
    <p>As a bonus, the nature of the API also allows us to easily add multiple constraints to <code>andX</code> and <code>orX</code> operator nodes, something not easily done with the native PHPCR builder:</p>

                <pre class="code-block-table"><code class="php"><button
            type="button"
            class="copy-to-clipboard"
            data-copy-element-id="69487286f3e59ef121682280194946e4d107ccc7"
            title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><div id="69487286f3e59ef121682280194946e4d107ccc7"><table class="code-block-table"><tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-1" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-1">1</a></td><td class="code-line" rowspan="9"><span class="hljs-meta">&lt;?php</span>
$qb-&gt;fromDocument(<span class="hljs-string">'Blog\Post'</span>, <span class="hljs-string">'p'</span>);

<span class="hljs-comment">// we can add one or many constraints to an "andX" node...</span>
$qb-&gt;where()-&gt;andX()
    -&gt;fieldIsset(<span class="hljs-string">'p.username'</span>)
    -&gt;gt()-&gt;field(<span class="hljs-string">'p.rank'</span>)-&gt;literal(<span class="hljs-number">50</span>)-&gt;end()
    -&gt;eq()-&gt;fueld(<span class="hljs-string">'p.title'</span>)-&gt;literal(<span class="hljs-string">'This is a title'</span>);
</td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-2" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-2">2</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-3" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-3">3</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-4" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-4">4</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-5" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-5">5</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-6" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-6">6</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-7" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-7">7</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-8" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-8">8</a></td></tr>
<tr><td class="line-number noselect"><a name="line-number-69487286f3e59ef121682280194946e4d107ccc7-9" class="line-number-anchor" /><a href="#line-number-69487286f3e59ef121682280194946e4d107ccc7-9">9</a></td></tr></table></div></code></pre>
                
    <p>The documentation is now online and is made up of both a guide and a reference:</p>

                

<ul>
    <li class="dash">Guide: <a href="http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder.html">http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder.html</a></li>
    <li class="dash">Reference: <a href="http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder-reference.html">http://docs.doctrine-project.org/projects/doctrine-phpcr-odm/en/latest/reference/query-builder-reference.html</a></li>
</ul>

        
    
        </div>
    </article>
    </main>

        <button id="back-to-top" title="Go to top">Top</button>

                
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://www.doctrine-project.org/frontend/js/bundle.js?1546fc"
                            integrity="sha384-ix9eb2EZyp9uayYpxmCQoylbz8msHl5wOg/aqZnD/3cxszNUGePN656MRg5GEgbm"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
            <script
            src="https://www.doctrine-project.org/frontend/js/prismjs.js?8aa1bb"
                            integrity="sha384-3EhgfeqnppOxFBVU40g8gS+IVvmh5+wGpe4mG2otPyExrkK9t4aq8uCUy2IDLKkR"
                        crossorigin="anonymous">
    </script>
    </body>
</html>
