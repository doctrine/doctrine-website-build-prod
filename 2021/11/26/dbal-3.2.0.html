<!DOCTYPE html>
<html>
    <head>
        <title>New Release: Doctrine DBAL 3.2.0 - Doctrine: PHP Open Source Project</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
            <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://www.doctrine-project.org/2021/11/26/dbal-3.2.0.html"
        },
        "headline": "New Release: Doctrine DBAL 3.2.0",
        "image": [
            "https://www.doctrine-project.org/images/og.png"
        ],
        "datePublished": "2021-11-26T00:00:00-05:00",
        "dateModified": "2021-11-26T00:00:00-05:00",
        "author": {
            "@type": "Person",
            "name": "Sergei Morozov"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Doctrine",
            "logo": {
                "@type": "ImageObject",
                "url": "https://www.doctrine-project.org/images/og.png"
            }
        },
        "description": "We are happy to announce the immediate availability of Doctrine DBAL 3.2.0. As most of the minor rel"
    }
    </script>
    <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/prismjs.css?d2443b"
                            integrity="sha384-IcJ7eow//K0xRBscZjnk8kawYxbm2eUAZ9D6Xf/n0yuAi1NCvwOkep1S8XqPNB3E"
                        crossorigin="anonymous"
    />

        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/index.css?6f24e1"
                        integrity="sha384-i3nJ5UEvy1W3KdgRXlvh23gLlxzUc/qdcze/WJmSjxXBMjc0qC+JMebqdn5F/QZe"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/2021/11/26/dbal-3.2.0.html" />
        <meta property="og:title" content="New Release: Doctrine DBAL 3.2.0 - Doctrine: PHP Open Source Project" />
        <meta property="og:description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar stop-war-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                 <a href="/stop-war.html">ðŸ‡ºðŸ‡¦ UKRAINE NEEDS YOUR HELP NOW!</a>
            </nav>

            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://www.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                    <a class="dropdown-item" href="/projects/skeleton-mapper.html">Skeleton Mapper</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/team/maintainers.html">Maintainers</a>
                                <a class="dropdown-item" href="/team/contributors.html">Contributors</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/doctrine-website/edit/master/source/blog/2021-11-26-dbal-3.2.0.md" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
            <article>
        <header>
            <h2>New Release: Doctrine DBAL 3.2.0</h2>
        </header>

        <p class="lead">
            Posted on <date>November 26, 2021</date>
                            by
                                    <a href="mailto:morozov@tut.by">Sergei Morozov</a>
                                    </p>

        <div class="row">
            <div class="col">
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>
            </div>
        </div>

        <hr />

        <div>
                <p>We are happy to announce the immediate availability of Doctrine DBAL 3.2.0. As most of the minor releases, this one
focuses on new features, improvements and deprecations of the old APIs. Here are some details on the most significant
features and improvements:</p>
<h2>Platform-aware schema comparison (<a href="https://github.com/doctrine/dbal/pull/4746">#4746</a>)</h2>
<p>Up until this release, the logic of comparing database schemas had a major design flaw: it took into account only the
abstract schema definitions without taking the target platform into account.</p>
<p>This flaw would lead to multiple issues which shared the same root cause: the two definitions could be considered
different by the DBAL, but they would produce the same DDL.</p>
<p>For instance, consider the two column definitions:</p>
<pre><code class="language-php">// old schema
$column1 = new Column('contents', Type::getType('text'));

// new schema
$column2 = new Column('contents', Type::getType('text'), ['default' =&gt; 'Hello, world!']);</code></pre>
<p>If we compared them with the comparator, we'd get a diff:</p>
<pre><code class="language-php">$comparator = new Comparator();
$comparator-&gt;diffColumn($column1, $column2);
// array(1) {
//   [0] =&gt;
//   string(7) "default"
// }</code></pre>
<p>This might be valid for the platforms that support the <code>DEFAULT</code>  constraint on <code>TEXT</code> columns but isn't valid for those
that don't support it (e.g. MySQL). Regardless of the diff, both definitions would produce the same DDL on MySQL:</p>
<pre><code class="language-sql">contents LONGTEXT NOT NULL</code></pre>
<p>An attempt to migrate the old schema to the new one would produce a false-positive diff but applying it wouldn't result
in any schema changes.</p>
<p>A false-negative diff was also possible. Consider these following example:</p>
<pre><code class="language-php">// old schema
$column1 = new Column('settings', Type::getType('json'));

// new schema
$column2 = new Column('settings', Type::getType('json'), ['length' =&gt; 16777215]);</code></pre>
<p>Comparison of the above column definitions should have triggered a diff on MySQL and migrate the underlying column
from <code>TEXT</code> to <code>MEDIUMTEXT</code> but it didn't, because the DBAL would ignore the length of the <code>TEXT</code> columns.</p>
<p>Apart from that, the DBAL would compare only a subset of the definitions, so some column options as the character set
and collation weren't taken into account during comparison at all.</p>
<h3>The new approach</h3>
<p>Instead of comparing abstract definitions on a per-property basis, the new implementation compares the DDL that is generated from both definitions for the target database platform. If the definitions produce the same DDL, they are considered equal. According to the tests and the number of resolved issues, this approach should be more accurate and less error-prone.</p>
<p>Implementing this approach was impossible without introducing a new API which rendered the existing API obsolete.</p>
<p>Prior to DBAL <code>3.2.0</code>, the schema comparator could be only instantiated directly via the <code>new</code> keyword:</p>
<pre><code class="language-php">$comparator = new Comparator();</code></pre>
<p>Instantiated like this, the comparator doesn't have a notion of the target database platform and cannot perform the comparison properly. That is why, this way of instantiation is deprecated in favor of instantiating the comparator by the schema manager:</p>
<pre><code class="language-php">$schemaManager = $connection-&gt;createSchemaManager();
$comparator = $schemaManager-&gt;createComparator();</code></pre>
<p>This way, the schema manager can instantiate a platform-specific comparator and provide it with the necessary context (e.g. the default collation used by the database).</p>
<p>While the old API is still available, it is recommended to use the new API for more accurate comparison.</p>
<h2>Support for <code>psr/cache</code> (<a href="https://github.com/doctrine/dbal/pull/4620">#4620</a>)</h2>
<p>Since the Doctrine Cache library is being sunset, the new DBAL release introduced the ability to use a PSR-6 compatible implementation for result caching.</p>
<p>While both the <code>doctrine/cache</code> and <code>psr/cache</code> APIs will be supported until the next major DBAL release, we recommend users to switch to a PSR-6 compatible implementation in their projects.</p>
<h2>Support for <code>psr/log</code> (<a href="https://github.com/doctrine/dbal/pull/4967">#4967</a>)</h2>
<p>The <code>SQLLogger</code> interface was designed long ago and has certain limitations: there is no way to log messages at different logger levels and it is really challenging to extend the logger functionality without introducing breaking API changes.</p>
<p>The new DBAL release introduces a new middleware that can delegate logging to a PSR-3 compatible implementation.</p>
<p>Note that the new logger won't produce the messages identical to the ones produced by the old one. If you have any processes built around analysing log messages, you may need to make some changes before adopting the new API.</p>
<h2>Always cache the full result (<a href="https://github.com/doctrine/dbal/pull/5003">#5003</a>)</h2>
<p>The implementation of the result cache prior to DBAL 3.2.0 would store the result set in the cache only once it was fetched completely. It led to the following issues:</p>
<ol>
<li>If the result isn't yet cached and its consumer didn't fetch it completely, the query would be executed again.</li>
<li>In case of a cache miss, the DBAL would <code>get()</code> the cache entry twice: once to fetch the data and once to merge the just fetched result with other results that may be stored in the cache.</li>
</ol>
<p>The new implementation stores the results in the cache right after they were fetched. It simplifies the caching layer significantly and makes its behavior more straightforward.</p>
<h2>Add events for Transaction begin/commit/rollback (<a href="https://github.com/doctrine/dbal/pull/4622">#4622</a>)</h2>
<p>The new DBAL version introduces three more transaction-related events:</p>
<ul>
<li><code>onTransactionBegin</code>,</li>
<li><code>onTransactionCommit</code>,</li>
<li><code>onTransactionRollBack</code>.</li>
</ul>
<p>Subscribing to those might be helpful if the application logic integrates the database transaction flow with the business logic implemented outside the database. For instance, in the filesystem.</p>
<h2>Basic exception handling in IBM DB2 and SQL Server drivers (<a href="https://github.com/doctrine/dbal/pull/4929">#4929</a>, <a href="https://github.com/doctrine/dbal/pull/4928">#4928</a>)</h2>
<p>The DBAL provides a mechanism that converts driver-specific error codes to portable error-specific exceptions. For instance an attempt to insert <code>NULL</code> into a column that has a <code>NOT NULL</code> constraint applied will result in error with the code <code>1566</code> on MySQL and in <code>ORA-01400</code> on Oracle. The DBAL will convert these two errors to a portable <code>NotNullConstraintViolationException</code>.</p>
<p>Historically, the DBAL drivers based on the <code>ibm_db2</code>, <code>sqlsrv</code> and <code>pdo_sqlsrv</code> extensions did not support this feature and would thow a generic <code>DriverException</code>.</p>
<p>As of DBAL 3.2.0, this feature is supported by all bundled drivers.</p>
<h2>Improved <code>AbstractPlatform::getLengthExpression()</code> (<a href="https://github.com/doctrine/dbal/pull/4855">#4855</a>)</h2>
<p>Although the <code>LENGTH</code> expression was implemented for all supported database platforms, the different implementations didn't have consistent semantics:</p>
<ol>
<li>Most implementations would return the length in characters (Unicode code points), which is the most expected behavior.</li>
<li>The implementations for MySQL and IBM DB2 would return the number of bytes. It worked fine for the strings that consisted only of the ANSI characters, but an attempt to use it with a wider range of characters would produce an unexpected result. For instance, the length of the string  <code>'ÐŸÑ€Ð¸Ð²ÐµÑ‚, Ð¼Ð¸Ñ€!'</code> might be reported as <code>19</code> instead of <code>12</code>.</li>
</ol>
<p>As of DBAL 3.2.0, all platforms return the length in Unicode points according to the character set used by the database connection. Note, SQL Server supports UTF-8 only as of SQL Server 2019.</p>
<p>You can find more details in the <a href="https://github.com/doctrine/dbal/releases/tag/3.2.0">release notes</a>.</p>
        </div>
    </article>
    </main>

        <button id="back-to-top" title="Go to top">Top</button>

                    <footer class="footer">
                <div class="container">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a href="/projects.html">Projects</a></li>
                        <li class="list-inline-item"><a href="/partners.html">Partners</a></li>
                        <li class="list-inline-item"><a href="/sponsorship.html">Sponsorship</a></li>
                        <li class="list-inline-item"><a href="/community/index.html">Community</a></li>
                        <li class="list-inline-item"><a href="/blog/index.html">Blog</a></li>
                    </ul>
                </div>
            </footer>
        
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://www.doctrine-project.org/frontend/js/bundle.js?c653f9"
                            integrity="sha384-rYJF/oL8vXltLq3dajavv7+WjiKu38w66LOxkZAG0zVMLF6ZF4FOZif7SyRFLWhv"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
            <script
            src="https://www.doctrine-project.org/frontend/js/prismjs.js?0b6349"
                            integrity="sha384-pkiLd6G8KC8B9KQTaXeVcYYLZgRGLHyx5vkGLK3G3w6Z2nzf8eNqmG/pbAdHx9tm"
                        crossorigin="anonymous">
    </script>
    </body>
</html>
