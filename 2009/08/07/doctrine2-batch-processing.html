<!DOCTYPE html>
<html>
    <head>
        <title>Doctrine 2 Batch Processing - Doctrine: PHP Open Source Project</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
            <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://www.doctrine-project.org/2009/08/07/doctrine2-batch-processing.html"
        },
        "headline": "Doctrine 2 Batch Processing",
        "image": [
            "https://www.doctrine-project.org/images/og.png"
        ],
        "datePublished": "2009-08-07T00:00:00-04:00",
        "dateModified": "2009-08-07T00:00:00-04:00",
        "author": {
            "@type": "Person",
            "name": "romanb"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Doctrine",
            "logo": {
                "@type": "ImageObject",
                "url": "https://www.doctrine-project.org/images/og.png"
            }
        },
        "description": "TIP Disclaimer: In general, an ORM is surely not the best tool :   for the job for mass data movemen"
    }
    </script>
    <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/prismjs.css?d2443b"
                            integrity="sha384-IcJ7eow//K0xRBscZjnk8kawYxbm2eUAZ9D6Xf/n0yuAi1NCvwOkep1S8XqPNB3E"
                        crossorigin="anonymous"
    />

        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/index.css?209f12"
                        integrity="sha384-VMcQOaUBPJYirNpZMqv0kKw80RSt4Uye4T1Li/d7kiKYAfj1WSzYOgP2OTdON/HM"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/2009/08/07/doctrine2-batch-processing.html" />
        <meta property="og:title" content="Doctrine 2 Batch Processing - Doctrine: PHP Open Source Project" />
        <meta property="og:description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://www.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item" href="/projects/rst-parser.html">RST Parser</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/sponsorship.html">Sponsorship</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/doctrine-website/edit/master/source/blog/2009-08-07-doctrine2-batch-processing.md" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>
                </div>
                <div class="nav-outbound">
                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
            <article>
        <div class="row">
            <div class="col-lg-8 col-12">
                <header>
                    <h2>Doctrine 2 Batch Processing</h2>
                </header>

                <p class="lead">
                    Posted on <date>August 7, 2009</date>
                                            by
                                                    romanb
                                                            </p>
            </div>

            <div class="col-lg-4 col-12">
                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7D553W&placement=wwwdoctrine-projectorg" id="_carbonads_js"></script>
            </div>
        </div>

        <hr />

        <div>
                
            
                
    <p><strong>TIP</strong> Disclaimer: In general, an ORM is surely not the best tool :   for the job for mass data movements, however, it can be a convenient alternative if the performance is sufficient. Every RDBMS has its own highly efficient commands for such operations. For maximum efficiency you should consult the manual of your RDBMS.</p>

                    <pre class="code-block-table" id="73132404dab933a89ccdfd97dca4b46d20f0eae1"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="73132404dab933a89ccdfd97dca4b46d20f0eae1"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">**NOTE** The hardware used <span class="hljs-keyword">for</span> the following tests: MBP, Intel Core</code><code class="line language-php"><span class="hljs-number">2</span> Duo <span class="hljs-number">2.53</span> Ghz, <span class="hljs-number">4</span>GB DDR3 RAM, <span class="hljs-number">7200</span>rpm HDD.</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>A lot of people have encountered the infamous &quot;memory exhausted&quot; errors when using Doctrine for bulk operations or in long-running scripts. This is a problem that is the result of 2 things:</p>

                

<ul>
    <li class="dash">The often unnecessarily intertwined architecture of Doctrine 1.x.</li>
    <li class="dash">
    <p>The simple garbage collector of PHP &lt; 5.3.</p>
<blockquote>
    <p><strong>NOTE</strong> If you did not know it yet, basically every circular reference between objects (and that is every bidirectional relationship!) is a potential memory leak in PHP &lt; 5.3.</p>
</blockquote></li>
</ul>

                
    <p>Now, the PHP team did their homework and introduced a new garbage collector in PHP 5.3 (that is enabled by default, thank god!) that is capable of properly detecting cyclic references that are not referenced any longer from the outside.</p>

                
    <p>In Doctrine 2 we did our part of the homework to address this issue and redesigned the Doctrine core from scratch. The result is a much better user experience, as I will demonstrate with some examples.</p>

                <h1 class="section-header ">
    <a href="#mass-inserts">
        Mass inserts
        <i class="fas fa-link"></i>
    </a>
</h1>
                
    <p>The first thing we will look at is mass inserts. In Doctrine 2 there is a special pattern that can be used for mass inserts that looks as follows:</p>

                    <pre class="code-block-table" id="a040242e2347393ef7fc99e546d9c67921afe9cd"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="a040242e2347393ef7fc99e546d9c67921afe9cd"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php"><span class="hljs-meta">&lt;?php</span></code><code class="line language-php"><span class="hljs-comment">// $em instanceof EntityManager</span></code><code class="line language-php">$batchSize = <span class="hljs-number">20</span>;</code><code class="line language-php"><span class="hljs-keyword">for</span> ($i=<span class="hljs-number">1</span>; $i&lt;=<span class="hljs-number">10000</span>; ++$i) {</code><code class="line language-php">     $obj = <span class="hljs-keyword">new</span> MyEntity;</code><code class="line language-php">     $obj-&gt;setFoo(<span class="hljs-string">'...'</span>);</code><code class="line language-php">     <span class="hljs-comment">// ... set more data</span></code><code class="line language-php">     $em-&gt;persist($obj);</code><code class="line language-php">     <span class="hljs-keyword">if</span> (($i % $batchSize) == <span class="hljs-number">0</span>) {</code><code class="line language-php">         $em-&gt;flush();</code><code class="line language-php">         $em-&gt;clear();</code><code class="line language-php">    }</code><code class="line language-php">}</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>I used this pattern to create a little demonstration that looks like this in a PHPUnit test:</p>

                    <pre class="code-block-table" id="43b3ac038274aa809a2be4a76d3632e9c7346bb8"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="43b3ac038274aa809a2be4a76d3632e9c7346bb8"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php"><span class="hljs-meta">&lt;?php</span></code><code class="line language-php"><span class="hljs-comment">// $this-&gt;_em created in setUp()</span></code><code class="line language-php"><span class="hljs-keyword">echo</span> <span class="hljs-string">"Memory usage before: "</span> . (memory_get_usage() / <span class="hljs-number">1024</span>) . <span class="hljs-string">" KB"</span> . PHP_EOL;</code><code class="line language-php">$s = microtime(<span class="hljs-keyword">true</span>);</code><code class="line language-php">$batchSize = <span class="hljs-number">20</span>;</code><code class="line language-php"><span class="hljs-keyword">for</span> ($i=<span class="hljs-number">1</span>; $i&lt;=<span class="hljs-number">10000</span>; ++$i) {</code><code class="line language-php">     $user = <span class="hljs-keyword">new</span> CmsUser;</code><code class="line language-php">     $user-&gt;status = <span class="hljs-string">'user'</span>;</code><code class="line language-php">     $user-&gt;username = <span class="hljs-string">'user'</span> . $i;</code><code class="line language-php">     $user-&gt;name = <span class="hljs-string">'Mr.Smith-'</span> . $i;</code><code class="line language-php">     <span class="hljs-keyword">$this</span>-&gt;_em-&gt;persist($user);</code><code class="line language-php">     <span class="hljs-keyword">if</span> (($i % $batchSize) == <span class="hljs-number">0</span>) {</code><code class="line language-php">         <span class="hljs-keyword">$this</span>-&gt;_em-&gt;flush();</code><code class="line language-php">         <span class="hljs-keyword">$this</span>-&gt;_em-&gt;clear();</code><code class="line language-php">    }</code><code class="line language-php">}</code><code class="line language-php"></code><code class="line language-php"><span class="hljs-comment">//gc_collect_cycles(); // explained later!</span></code><code class="line language-php"><span class="hljs-keyword">echo</span> <span class="hljs-string">"Memory usage after: "</span> . (memory_get_usage() / <span class="hljs-number">1024</span>) . <span class="hljs-string">" KB"</span> . PHP_EOL;</code><code class="line language-php"></code><code class="line language-php">$e = microtime(<span class="hljs-keyword">true</span>);</code><code class="line language-php"><span class="hljs-keyword">echo</span> <span class="hljs-string">' Inserted 10000 objects in '</span> . ($e - $s) . <span class="hljs-string">' seconds'</span> . PHP_EOL;</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>As you can see, we insert a total of 10000 objects. On running this code through PHPUnit, using an SQLite in-memory database, I got the following output:</p>

                    <pre class="code-block-table" id="8d18a149fdb8f4cab2bdf94e78fee6326ca44e86"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="8d18a149fdb8f4cab2bdf94e78fee6326ca44e86"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">Memory usage before: <span class="hljs-number">5034.03515625</span> KB</code><code class="line language-php">Memory usage after: <span class="hljs-number">6726.3515625</span> KB</code><code class="line language-php">Inserted <span class="hljs-number">10000</span> objects in <span class="hljs-number">3.165983915329</span> seconds</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>We can see the following:</p>

                

<ul>
    <li class="dash">The insertion of 10000 objects through Doctrine into an SQLite in-memory database took roughly 3 seconds, not too bad.</li>
    <li class="dash">Memory usage increased by roughly 1.7MB, not too bad either.</li>
</ul>

                
    <p>If you are now still not satisfied and wonder where the 1.7MB are going, here is the answer: A small part of that is occupied by objects that were created on-demand internally by Doctrine, these will stay pretty constant, however. But the majority of this 1.7MB has simply not yet been reclaimed (but is eliglible for garbage collection for the new garbage collector!). To prove that, I can just uncomment the gc_collect_cycles() function call. Here&#039;s the result:</p>

                    <pre class="code-block-table" id="bb5aff20d06250dc8a76ac069db96974f98dc9f9"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="bb5aff20d06250dc8a76ac069db96974f98dc9f9"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">Memory usage before: <span class="hljs-number">5034.3828125</span> KB</code><code class="line language-php">Memory usage after: <span class="hljs-number">5502.21484375</span> KB</code><code class="line language-php">Inserted <span class="hljs-number">10000</span> objects in <span class="hljs-number">3.1807188987732</span> seconds</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>Much better! And to prove that the ~500KB occupied by Doctrine are constant, I simply made it 20000 objects. Here is the result:</p>

                    <pre class="code-block-table" id="81da27f2b0e92bb88386a6372353fb6787b3378d"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="81da27f2b0e92bb88386a6372353fb6787b3378d"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">Memory usage before: <span class="hljs-number">5034.3828125</span> KB</code><code class="line language-php">Memory usage after: <span class="hljs-number">5502.21484375</span> KB</code><code class="line language-php">Inserted <span class="hljs-number">20000</span> objects in <span class="hljs-number">6.6149919033051</span> seconds</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>We can see the following things:</p>

                

<ul>
    <li class="dash">Memory usage is constant, the second batch of 10000 objects did not result in additional memory usage.</li>
    <li class="dash">The mass insertion strategy scales almost linearly. 10k objects took ~3.2 seconds and 20k objects took ~6.6 seconds.</li>
</ul>

                
    <p>Note: You do not really need to call gc_collect_cycles(). This should just demonstrate that the memory can be reclaimed. PHP would reclaim that memory anyway when it needs to.</p>

                
    <p>Even better, when testing the peak memory usage (memory_get_peak_usage()) it turned out that the memory usage never grew beyond ~10MB in between. If you choose a larger batch size the peak memory usage will be higher and vice versa.</p>

                <h1 class="section-header ">
    <a href="#mass-object-processing">
        Mass object processing
        <i class="fas fa-link"></i>
    </a>
</h1>
                
    <p>Now we take a look at mass-processing objects, which means loading 10000 objects from the database and doing something with each of them. The clue here is the new support for iterative (step-by-step) hydration in Doctrine 2. The pattern for these kinds of tasks looks as follows:</p>

                    <pre class="code-block-table" id="50c37d7b2f154aa7f79fd50ca94835a86f928aff"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="50c37d7b2f154aa7f79fd50ca94835a86f928aff"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php"><span class="hljs-meta">&lt;?php</span></code><code class="line language-php">$q = <span class="hljs-keyword">$this</span>-&gt;_em-&gt;createQuery(<span class="hljs-string">"&lt;DQL to select the objects I want&gt;"</span>);</code><code class="line language-php">$iterableResult = $q-&gt;iterate();</code><code class="line language-php"><span class="hljs-keyword">while</span> (($row = $iterableResult-&gt;next()) !== <span class="hljs-keyword">false</span>) {</code><code class="line language-php">        <span class="hljs-comment">// do stuff with the data in the row, $row[0] is always the object</span></code><code class="line language-php">        <span class="hljs-keyword">$this</span>-&gt;_em-&gt;detach($row[<span class="hljs-number">0</span>]); <span class="hljs-comment">// detach from Doctrine, so that it can be GC'd immediately</span></code><code class="line language-php"> }</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>So instead of using <code>$q-&gt;execute()</code> or <code>$q-&gt;getResult()</code> or similar, we use <code>$q-&gt;iterate()</code> which returns an instance of <code>IterableResult</code> that allows us to iterate over the result step by step. The important part for not running out of memory is the line where the created object is detached from Doctrine, which results in Doctrine removing any internal references to that object, Doctrine no longer &quot;knows&quot; about that object.</p>

                
    <p>I used this pattern to iterate through the just inserted 10000 objects as follows:</p>

                    <pre class="code-block-table" id="e40e63816962563dced006824f06ac74fe7ba10e"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="e40e63816962563dced006824f06ac74fe7ba10e"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php"><span class="hljs-meta">&lt;?php</span></code><code class="line language-php">$q = <span class="hljs-keyword">$this</span>-&gt;_em-&gt;createQuery(<span class="hljs-string">"select u from Doctrine\Tests\Models\CMS\CmsUser u"</span>);</code><code class="line language-php">$iterableResult = $q-&gt;iterate();</code><code class="line language-php"></code><code class="line language-php"><span class="hljs-keyword">echo</span> <span class="hljs-string">"Memory usage before: "</span> . (memory_get_usage() / <span class="hljs-number">1024</span>) . <span class="hljs-string">" KB"</span> . PHP_EOL;</code><code class="line language-php"></code><code class="line language-php"><span class="hljs-keyword">while</span> (($row = $iterableResult-&gt;next()) !== <span class="hljs-keyword">false</span>) {</code><code class="line language-php">    <span class="hljs-comment">// ... I could do some stuff here</span></code><code class="line language-php">    <span class="hljs-keyword">$this</span>-&gt;_em-&gt;detach($row[<span class="hljs-number">0</span>]);</code><code class="line language-php">}</code><code class="line language-php"></code><code class="line language-php"><span class="hljs-keyword">echo</span> <span class="hljs-string">"Memory usage after: "</span> . (memory_get_usage() / <span class="hljs-number">1024</span>) . <span class="hljs-string">" KB"</span> . PHP_EOL;</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>The following is the result:</p>

                    <pre class="code-block-table" id="36d09cce75ba587e2b893a864c7a31723c769af9"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="36d09cce75ba587e2b893a864c7a31723c769af9"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">Memory usage before: <span class="hljs-number">6578.58984375</span> KB</code><code class="line language-php">Memory usage after: <span class="hljs-number">6581.71875</span> KB</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>The result is pretty acceptable. Here is the same again, this time for 20000 objects, again to prove that the small memory increase is constant:</p>

                    <pre class="code-block-table" id="935fc0b359242eceb431c2666692ec06f9808311"><button
                type="button"
                class="copy-to-clipboard"
                data-copy-element-id="935fc0b359242eceb431c2666692ec06f9808311"
                title="Copy to Clipboard"
        ><i class="fas fa-copy"></i></button><code class="empty"></code><code class="line language-php">Memory usage before: <span class="hljs-number">6578.23828125</span> KB</code><code class="line language-php">Memory usage after: <span class="hljs-number">6581.359375</span> KB</code><code class="line language-php"></code><code class="empty"></code></pre>
                
    <p>Good stuff!</p>

                <blockquote>
    <p><strong>NOTE</strong> If you&#039;re thinking that I waited ages until the 10k or 20k objects were hydrated, that was not the case. 10k or 20k objects (without associations) are hydrated in seconds.</p>
</blockquote>
                
    <p>More information on bulk operations with Doctrine 2 can be found in the (very new) online manual that is still a work in progress:</p>

                
    <p><a href="https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/batch-processing.html#batch-processing">https://www.doctrine-project.org/projects/doctrine-orm/en/current/reference/batch-processing.html#batch-processing</a></p>

                <h1 class="section-header ">
    <a href="#update">
        UPDATE
        <i class="fas fa-link"></i>
    </a>
</h1>
                
    <p>Some people seem to be wondering why Doctrine does not use multi-inserts (insert into (...) values (...), (...), (...), ...</p>

                
    <p>First of all, this syntax is only supported on mysql and newer postgresql versions. Secondly, there is no easy way to get hold of all the generated identifiers in such a multi-insert when using AUTO_INCREMENT or SERIAL and an ORM needs the identifiers for identity management of the objects. Lastly, insert performance is rarely the bottleneck of an ORM. Normal inserts are more than fast enough for most situations and if you really want to do fast bulk inserts, then a multi-insert is not the best way anyway, i.e. Postgres COPY or Mysql LOAD DATA INFILE are several orders of magnitude faster.</p>

                
    <p>These are the reasons why it is not worth the effort to implement an abstraction that performs multi-inserts on mysql and postgresql in an ORM.</p>

                
    <p>I hope that clears up some questionmarks.</p>

        
    
        </div>
    </article>
    </main>

        <button id="back-to-top" title="Go to top">Top</button>

                
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://www.doctrine-project.org/frontend/js/bundle.js?4a831b"
                            integrity="sha384-ygNM6vWkqMgvV0Lrk5BeKUupSk4CidmuzVPL3OkdAxEVjZQDo9cgbfC+FXAfoAse"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
            <script
            src="https://www.doctrine-project.org/frontend/js/prismjs.js?e97886"
                            integrity="sha384-gKhxdEN1Hcl/o+IxbVbpfZRfdDPQe5dwOuCcWYbhCAhhkOl/Vi2VmnWe9/UCD6rW"
                        crossorigin="anonymous">
    </script>
    </body>
</html>
