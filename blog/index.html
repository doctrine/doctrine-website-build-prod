<!DOCTYPE html>
<html>
    <head>
        <title>Blog - Doctrine: PHP Open Source Project</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
            <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/prismjs.css?d2443b"
                            integrity="sha384-IcJ7eow//K0xRBscZjnk8kawYxbm2eUAZ9D6Xf/n0yuAi1NCvwOkep1S8XqPNB3E"
                        crossorigin="anonymous"
    />

        <link
            rel="stylesheet"
            type="text/css"
            href="https://www.doctrine-project.org/frontend/css/index.css?872f7e"
                        integrity="sha384-bZsEB71Y4iNSgVBqRpdfrMlt47Yelru109ZBtBWZTOqrVUwMj1ilWncB/TvsLRw5"
                        crossorigin="anonymous"
        />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineproject" />
        <meta name="twitter:creator" content="@doctrineproject" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/blog/index.html" />
        <meta property="og:title" content="Blog - Doctrine: PHP Open Source Project" />
        <meta property="og:description" content="The Doctrine Project is an open-source PHP project that is home to home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/logos/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineproject"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    
            <nav class="doctrine-navbar stop-war-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                 <a href="/stop-war.html">ðŸ‡ºðŸ‡¦ UKRAINE NEEDS YOUR HELP NOW!</a>
            </nav>

            <nav class="doctrine-navbar navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="/index.html"><img src="https://www.doctrine-project.org/logos/doctrine-logo.svg?1a5b7c" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/data-fixtures.html">Data fixtures</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/instantiator.html">Instantiator</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/reflection.html">Reflection</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/rst-parser.html">RST Parser</a>
                                                                    <a class="dropdown-item notranslate" href="/projects/skeleton-mapper.html">Skeleton Mapper</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="/contribute/index.html" id="navbarDevelopmentDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Development</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="/community/index.html">Community</a>
                                <a class="dropdown-item" href="/contribute/index.html">Contributor Workflow</a>
                                <a class="dropdown-item" href="/contribute/maintainer/index.html">Maintainer Workflow</a>
                                <a class="dropdown-item" href="/contribute/website/index.html">Contribute to Website</a>
                                <a class="dropdown-item" href="/team/maintainers.html">Maintainers</a>
                                <a class="dropdown-item" href="/team/contributors.html">Contributors</a>
                                <a class="dropdown-item" href="/policies.html">Policies</a>
                                <a class="dropdown-item" href="https://github.com/doctrine" target="_blank" rel="noopener noreferrer">GitHub</a>
                                <a class="dropdown-item" href="/styleguide.html">Styleguide</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/events.html">Events</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/consulting.html">Consulting</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link" href="/partners.html">Partners</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="/blog/index.html">Blog</a>
                        </li>
                    </ul>

                    <div class="layout-edit-button d-inline-block mr-2">
                                                    <a href="https://github.com/doctrine/doctrine-website/edit/master/source/blog.html" class="btn btn-light" target="_blank" rel="noopener noreferrer">Edit</a>
                                            </div>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank" rel="noopener noreferrer"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
                        <article>
        <header>
            <h2><a href="/2022/01/22/sunsetting-dbal-2.html">Sunsetting Doctrine DBAL 2</a></h2>
        </header>

        <p class="lead">
            Posted on <date>January 22, 2022</date>
                            by
                                    <a href="mailto:morozov@tut.by">Sergei Morozov</a>
                                    </p>

        <hr />

        <div>
            <p>Since the release of <a href="https://github.com/doctrine/dbal/releases/tag/3.0.0">Doctrine DBAL 3.0.0 </a> in November 2020,
the 2.x release series effectively went into the maintenance mode. In the past year, we've been accepting mostly
the following types of patches for DBAL 2:</p>
<ol>
<li>Development dependency updates</li>
<li>Security fixes</li>
<li>Improvements to compatibility with PHP 8.1</li>
<li>Improvements in the upgrade path to DBAL 3</li>
</ol>
<p>Except for dependency updates, at the moment, there are no known issues in DBAL 2 that would fall into any of
the above categories.</p>
<p>Many projects that depend on Doctrine DBAL depend on it indirectly via Doctrine ORM which until
<a href="https://github.com/doctrine/orm/releases/tag/2.10.0">release 2.10.0</a> didn't support DBAL 3.
It was one of the blockers of the DBAL 3 adoption which is no longer the case.</p>
<p>With all that said, the DBAL team announces the plan for sunsetting DBAL 2 in 6 months as of the ORM 2.10.0 release
which is April 3, 2022. After that date, we plan to release DBAL 2 only to address security related
and other critical issues for at most a year.</p>
<p>All Doctrine DBAL users are encourarged to upgrade to the latest stable version
which is <a href="https://github.com/doctrine/dbal/releases/tag/3.3.0">3.3.0</a> as of the time of this writing.</p>
<p>For migrating from DBAL 2 to 3, see our two blog posts on DBAL 2.13 Forward Compatibility Layer:</p>
<ul>
<li><a href="https://www.doctrine-project.org/2021/03/29/dbal-2.13.html">New Release: Doctrine DBAL 2.13 with Deprecations and Forward Compatibility</a></li>
<li><a href="https://www.doctrine-project.org/2021/04/19/dbal-2.13.1-3.1.0.html">New Release: Doctrine DBAL 2.13.1 and 3.1.0 with important Forward Compatibility fix</a></li>
</ul>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2022/01/11/orm-2.11.html">New Release: Doctrine ORM 2.11 with Enums, Virtual Columns, Read-Only Properties, Nested Attributes and more</a></h2>
        </header>

        <p class="lead">
            Posted on <date>January 11, 2022</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>We have released a new minor version 2.11 of Doctrine ORM with several improvements
and new features.</p>
<p><a href="https://github.com/doctrine/orm/releases/tag/2.11.0">See all changes and contributors in the
Changelog</a> on Github.</p>
<p>This blog post gives an overview over all the new features and improvements
that are user facing. Please see the changelog and UPGRADE notes for new
deprecations.</p>
<h2>PHP 8.1 Enum Support</h2>
<p>With PHP 8.1 the language has first class support for enumerations and Doctrine
ORM 2.11 supports the mapping of database values to <a href="https://www.php.net/manual/en/language.enumerations.backed.php">Backed
Enums</a>.</p>
<p>The support is not integrated on DBAL Type level, but using a new mapping option
called <code>enumType</code> on column/field declaration level:</p>
<pre><code class="language-php">enum Suit: string {
    case Hearts = 'H';
    case Diamonds = 'D';
    case Clubs = 'C';
    case Spades = 'S';
}

#[Entity]
class Card
{
    /** ... */

    #[Column(type: 'string', enumType: Suit::class)]
    public $suit;
}</code></pre>
<h2>Virtual and Generated Columns</h2>
<p>There has been constant demand for this feature for a long time, to add support
for columns that are not insertable/updatable and might have their value
updated on the database side.</p>
<p>We have worked along the lines of Java Persistence API support of <code>insertable</code>,
<code>updatable</code> and <code>generated</code> options for field mappings.</p>
<p>There are two major use cases for this:</p>
<ol>
<li>Map a column several times, for example with join columns:</li>
</ol>
<pre><code class="language-php">#[Entity]
class User
{
     #[ManyToOne(targetEntity: Country:class), JoinColumn(name: "country_code", referencedColumnName: "country_code")]
     public $country;

     #[Column(type: "string", name: "country_code", insertable: false, updatable: false)]
     public $countryCode;
}</code></pre>
<ol start="2">
<li>Columns updated by the database</li>
</ol>
<pre><code class="language-php">#[Entity]
class Article
{
    #[Column(type: "datetime",
        columnDefinition: "TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP",
        insertable: false,
        updatable: false,
        generated: "ALWAYS")]
    public $created;
}</code></pre>
<h2>Support for Readonly Properties</h2>
<p>Another PHP 8.1 feature is the new readonly keyword that prevents the value of
a property to be written again after it has been initialized in the constructor
of an object.</p>
<p>With ORM 2.11 the support now works as you would expect with no additional
mapping options necessary:</p>
<pre><code class="language-php">#[Entity, Table(name: 'author')]
class Author
{
    #[Column, Id, GeneratedValue]
    private readonly int $id;

    #[Column]
    private readonly string $name;
}</code></pre>
<h2>AssociationOverrides and AttributeOverrides in Attribute Driver</h2>
<p>The new <code>AttributeDriver</code> for PHP 8 did not support the equivalent mapping
options for association and attribute overrides that are available for XML and
Annotation mapping, because in PHP 8.0 it was not possible to nest complex
attributes. </p>
<p>With the support now available in PHP 8.1 we have added these attributes.</p>
<pre><code class="language-php">&lt;?php
use Doctrine\ORM\Mapping\AssociationOverride;
use Doctrine\ORM\Mapping\AssociationOverrides;
use Doctrine\ORM\Mapping\AttributeOverride;
use Doctrine\ORM\Mapping\AttributeOverrides;
use Doctrine\ORM\Mapping\Column;
use Doctrine\ORM\Mapping\Entity;

#[AssociationOverrides([
    new AssociationOverride(
        name: "groups",
        joinTable: new JoinTable(
            name: "ddc964_users_admingroups",
        ),
        joinColumns: [new JoinColumn(name: "adminuser_id")],
        inverseJoinColumns: [new JoinColumn(name: "admingroup_id")]
    )
])]
#[AttributeOverrides([
    new AttributeOverride(
        name: "id",
        column: new Column(name: "guest_id", type: "integer", length: 140)
    )])]
class DDC964Admin extends DDC964User
{
}</code></pre>
<p>For PHP 8.0 we have already moved <code>Index</code> and <code>JoinColumn</code> mappings to the top
level to avoid nesting and decided not to allow nesting for these to mimic
annotation support.</p>
<h2>Allow arithmetic expressions within IN operator</h2>
<p>It is now possible to use arithmetic expressions or functions inside the IN operator:</p>
<pre><code class="language-sql">SELECT u FROM User u WHERE u.id IN (1 + 1, FOO(u.id))</code></pre>
<h2>Ignore entity classes in schema tool</h2>
<p>You can now specify Entity FQCNs to ignore during schema tool creation and comparison.
<code>SchemaTool</code> will then skip these (e.g. when comparing schemas).</p>
<pre><code class="language-php">&lt;?php
$config-&gt;setSchemaIgnoreClasses([$fqcn]);
$config-&gt;getSchemaIgnoreClasses();</code></pre>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/12/04/mongodb-odm-2.3.html">New Release: Doctrine MongoDB ODM 2.3 with Attributes, JSON Schema Validation, and more</a></h2>
        </header>

        <p class="lead">
            Posted on <date>December 4, 2021</date>
                            by
                                    <a href="mailto:ion.bazan@gmail.com">Ion Bazan</a>
                                    </p>

        <hr />

        <div>
            <p>We have released a new minor version 2.3 of Doctrine MongoDB ODM, the first version
with support for using PHP 8 Attributes as a new driver for mapping documents
and several other changes. <a href="https://github.com/doctrine/mongodb-odm/releases/tag/2.3.0">See all changes and contributors in the
Changelog</a> on GitHub.</p>
<h2>Attributes Mapping Driver</h2>
<p>The following code example shows many of the mappings that are re-using
the annotation classes for familiarity:</p>
<pre><code class="language-php">use Doctrine\ODM\MongoDB\Mapping\Annotations as MongoDB;
use Doctrine\ODM\MongoDB\Types\Type;

#[MongoDB\Document(repositoryClass: PostRepository::class)]
class Post
{
    #[MongoDB\Id]
    private string $id;

    #[MongoDB\Field(type: Type::BOOLEAN)]
    private bool $published = false;

    #[MongoDB\Field(type: Types::COLLECTION)]
    private array $text = [];

    #[MongoDB\ReferenceOne(targetDocument: User::class)]
    public $author;

    #[MongoDB\ReferenceMany(targetDocument: Tag::class)]
    public Collection $tags;
}</code></pre>
<p>You may want to use <a href="https://getrector.org/">Rector</a> with <code>DoctrineSetList::DOCTRINE_ODM_23</code> set
to convert all your annotation mappings to attributes in seconds!</p>
<h2>JSON Schema Validation</h2>
<p>MongoDB â‰¥ 3.6 offers the capability to validate documents during
insertions and updates through a JSON schema associated with the collection.
<a href="https://docs.mongodb.com/manual/core/schema-validation/">See MongoDB documentation</a>.</p>
<p>Doctrine MongoDB ODM now provides a way to take advantage of this functionality thanks to the new
<a href="https://www.doctrine-project.org/projects/doctrine-mongodb-odm/en/latest/reference/annotations-reference.html#validation"><code>#[Validation]</code></a> mapping.</p>
<pre><code class="language-php">use Doctrine\ODM\MongoDB\Mapping\Annotations as MongoDB;
use Doctrine\ODM\MongoDB\Mapping\ClassMetadata;

#[MongoDB\Document]
#[MongoDB\Validation(
    validator: SchemaValidated::VALIDATOR,
    action: ClassMetadata::SCHEMA_VALIDATION_ACTION_WARN
)]
class SchemaValidated
{
    public const VALIDATOR = &lt;&lt;&lt;'EOT'
{
    "$jsonSchema": {
        "required": ["name"],
        "properties": {
            "name": {
                "bsonType": "string",
                "description": "must be a string and is required"
            }
        }
    },
    "$or": [
        { "phone": { "$type": "string" } },
        { "email": { "$regex": { "$regularExpression" : { "pattern": "@mongodb\\.com$", "options": "" } } } },
        { "status": { "$in": [ "Unknown", "Incomplete" ] } }
    ]
}
EOT;
}
</code></pre>
<p>Once defined, those options will be added to the collection after running
the <code>odm:schema:create</code> or <code>odm:schema:update</code> command.</p>
<h2>Psalmified APIs</h2>
<p>In-code documentation has been immensely improved to make sure static analysis tools and IDEs know
about the right document classes returned from <code>DocumentManager</code>,
<code>ClassMetadata</code>, and other public APIs. This includes generics support
for your own repositories extending <code>DocumentRepository</code>.</p>
<pre><code class="language-php">use Doctrine\ODM\MongoDB\Repository\DocumentRepository;
use App\Document\User;

/**
 * @template-extends DocumentRepository&lt;User&gt;
 */
class UserRepository extends DocumentRepository
{
}</code></pre>
<h2>Deprecations</h2>
<p>Doctrine MongoDB ODM 2.3 introduces several minor deprecations:</p>
<ul>
<li>The <code>Doctrine\ODM\MongoDB\Proxy\Resolver\ClassNameResolver</code> interface has been deprecated in favor
of the <code>Doctrine\Persistence\Mapping\ProxyClassNameResolver</code> interface</li>
<li>Annotation classes no longer extend <code>Doctrine\Common\Annotations\Annotation</code> class</li>
<li>Annotation arguments switched to <code>@NamedArgumentConstructor</code> for Attribute compatibility</li>
<li><code>@Inheritance</code> annotation has been removed as it was never used</li>
<li>Document Namespace Aliases (<code>'MyBundle:User</code>) - use fully qualified class names instead (<code>User::class</code>)</li>
</ul>
<p>Read more in our <a href="https://github.com/doctrine/mongodb-odm/blob/2.3.x/UPGRADE-2.3.md">upgrading</a> document. </p>
<h2>Coding Standard Support</h2>
<p>Doctrine MongoDB ODM 2.3 now supports and fully validates against Doctrine Coding
Standard version 9.0+. This greatly improves automatic pull request checks as
all new violations in a PR get caught and inlined into the PR as comments.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/11/26/dbal-3.2.0.html">New Release: Doctrine DBAL 3.2.0</a></h2>
        </header>

        <p class="lead">
            Posted on <date>November 26, 2021</date>
                            by
                                    <a href="mailto:morozov@tut.by">Sergei Morozov</a>
                                    </p>

        <hr />

        <div>
            <p>We are happy to announce the immediate availability of Doctrine DBAL 3.2.0. As most of the minor releases, this one
focuses on new features, improvements and deprecations of the old APIs. Here are some details on the most significant
features and improvements:</p>
<h2>Platform-aware schema comparison (<a href="https://github.com/doctrine/dbal/pull/4746">#4746</a>)</h2>
<p>Up until this release, the logic of comparing database schemas had a major design flaw: it took into account only the
abstract schema definitions without taking the target platform into account.</p>
<p>This flaw would lead to multiple issues which shared the same root cause: the two definitions could be considered
different by the DBAL, but they would produce the same DDL.</p>
<p>For instance, consider the two column definitions:</p>
<pre><code class="language-php">// old schema
$column1 = new Column('contents', Type::getType('text'));

// new schema
$column2 = new Column('contents', Type::getType('text'), ['default' =&gt; 'Hello, world!']);</code></pre>
<p>If we compared them with the comparator, we'd get a diff:</p>
<pre><code class="language-php">$comparator = new Comparator();
$comparator-&gt;diffColumn($column1, $column2);
// array(1) {
//   [0] =&gt;
//   string(7) "default"
// }</code></pre>
<p>This might be valid for the platforms that support the <code>DEFAULT</code>  constraint on <code>TEXT</code> columns but isn't valid for those
that don't support it (e.g. MySQL). Regardless of the diff, both definitions would produce the same DDL on MySQL:</p>
<pre><code class="language-sql">contents LONGTEXT NOT NULL</code></pre>
<p>An attempt to migrate the old schema to the new one would produce a false-positive diff but applying it wouldn't result
in any schema changes.</p>
<p>A false-negative diff was also possible. Consider these following example:</p>
<pre><code class="language-php">// old schema
$column1 = new Column('settings', Type::getType('json'));

// new schema
$column2 = new Column('settings', Type::getType('json'), ['length' =&gt; 16777215]);</code></pre>
<p>Comparison of the above column definitions should have triggered a diff on MySQL and migrate the underlying column
from <code>TEXT</code> to <code>MEDIUMTEXT</code> but it didn't, because the DBAL would ignore the length of the <code>TEXT</code> columns.</p>
<p>Apart from that, the DBAL would compare only a subset of the definitions, so some column options as the character set
and collation weren't taken into account during comparison at all.</p>
<h3>The new approach</h3>
<p>Instead of comparing abstract definitions on a per-property basis, the new implementation compares the DDL that is generated from both definitions for the target database platform. If the definitions produce the same DDL, they are considered equal. According to the tests and the number of resolved issues, this approach should be more accurate and less error-prone.</p>
<p>Implementing this approach was impossible without introducing a new API which rendered the existing API obsolete.</p>
<p>Prior to DBAL <code>3.2.0</code>, the schema comparator could be only instantiated directly via the <code>new</code> keyword:</p>
<pre><code class="language-php">$comparator = new Comparator();</code></pre>
<p>Instantiated like this, the comparator doesn't have a notion of the target database platform and cannot perform the comparison properly. That is why, this way of instantiation is deprecated in favor of instantiating the comparator by the schema manager:</p>
<pre><code class="language-php">$schemaManager = $connection-&gt;createSchemaManager();
$comparator = $schemaManager-&gt;createComparator();</code></pre>
<p>This way, the schema manager can instantiate a platform-specific comparator and provide it with the necessary context (e.g. the default collation used by the database).</p>
<p>While the old API is still available, it is recommended to use the new API for more accurate comparison.</p>
<h2>Support for <code>psr/cache</code> (<a href="https://github.com/doctrine/dbal/pull/4620">#4620</a>)</h2>
<p>Since the Doctrine Cache library is being sunset, the new DBAL release introduced the ability to use a PSR-6 compatible implementation for result caching.</p>
<p>While both the <code>doctrine/cache</code> and <code>psr/cache</code> APIs will be supported until the next major DBAL release, we recommend users to switch to a PSR-6 compatible implementation in their projects.</p>
<h2>Support for <code>psr/log</code> (<a href="https://github.com/doctrine/dbal/pull/4967">#4967</a>)</h2>
<p>The <code>SQLLogger</code> interface was designed long ago and has certain limitations: there is no way to log messages at different logger levels and it is really challenging to extend the logger functionality without introducing breaking API changes.</p>
<p>The new DBAL release introduces a new middleware that can delegate logging to a PSR-3 compatible implementation.</p>
<p>Note that the new logger won't produce the messages identical to the ones produced by the old one. If you have any processes built around analysing log messages, you may need to make some changes before adopting the new API.</p>
<h2>Always cache the full result (<a href="https://github.com/doctrine/dbal/pull/5003">#5003</a>)</h2>
<p>The implementation of the result cache prior to DBAL 3.2.0 would store the result set in the cache only once it was fetched completely. It led to the following issues:</p>
<ol>
<li>If the result isn't yet cached and its consumer didn't fetch it completely, the query would be executed again.</li>
<li>In case of a cache miss, the DBAL would <code>get()</code> the cache entry twice: once to fetch the data and once to merge the just fetched result with other results that may be stored in the cache.</li>
</ol>
<p>The new implementation stores the results in the cache right after they were fetched. It simplifies the caching layer significantly and makes its behavior more straightforward.</p>
<h2>Add events for Transaction begin/commit/rollback (<a href="https://github.com/doctrine/dbal/pull/4622">#4622</a>)</h2>
<p>The new DBAL version introduces three more transaction-related events:</p>
<ul>
<li><code>onTransactionBegin</code>,</li>
<li><code>onTransactionCommit</code>,</li>
<li><code>onTransactionRollBack</code>.</li>
</ul>
<p>Subscribing to those might be helpful if the application logic integrates the database transaction flow with the business logic implemented outside the database. For instance, in the filesystem.</p>
<h2>Basic exception handling in IBM DB2 and SQL Server drivers (<a href="https://github.com/doctrine/dbal/pull/4929">#4929</a>, <a href="https://github.com/doctrine/dbal/pull/4928">#4928</a>)</h2>
<p>The DBAL provides a mechanism that converts driver-specific error codes to portable error-specific exceptions. For instance an attempt to insert <code>NULL</code> into a column that has a <code>NOT NULL</code> constraint applied will result in error with the code <code>1566</code> on MySQL and in <code>ORA-01400</code> on Oracle. The DBAL will convert these two errors to a portable <code>NotNullConstraintViolationException</code>.</p>
<p>Historically, the DBAL drivers based on the <code>ibm_db2</code>, <code>sqlsrv</code> and <code>pdo_sqlsrv</code> extensions did not support this feature and would thow a generic <code>DriverException</code>.</p>
<p>As of DBAL 3.2.0, this feature is supported by all bundled drivers.</p>
<h2>Improved <code>AbstractPlatform::getLengthExpression()</code> (<a href="https://github.com/doctrine/dbal/pull/4855">#4855</a>)</h2>
<p>Although the <code>LENGTH</code> expression was implemented for all supported database platforms, the different implementations didn't have consistent semantics:</p>
<ol>
<li>Most implementations would return the length in characters (Unicode code points), which is the most expected behavior.</li>
<li>The implementations for MySQL and IBM DB2 would return the number of bytes. It worked fine for the strings that consisted only of the ANSI characters, but an attempt to use it with a wider range of characters would produce an unexpected result. For instance, the length of the string  <code>'ÐŸÑ€Ð¸Ð²ÐµÑ‚, Ð¼Ð¸Ñ€!'</code> might be reported as <code>19</code> instead of <code>12</code>.</li>
</ol>
<p>As of DBAL 3.2.0, all platforms return the length in Unicode points according to the character set used by the database connection. Note, SQL Server supports UTF-8 only as of SQL Server 2019.</p>
<p>You can find more details in the <a href="https://github.com/doctrine/dbal/releases/tag/3.2.0">release notes</a>.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/11/11/dbal3-vulnerability-fixed.html">DBAL 3 SQL Injection Security Vulnerability fixed (CVE-2021-43608)</a></h2>
        </header>

        <p class="lead">
            Posted on <date>November 11, 2021</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>We have released a new version Doctrine DBAL 3.1.4 that fixes a critical SQL
injection vulnerability in the LIMIT clause generation API provided by the
Platform abstraction.</p>
<p>We advise everyone using Doctrine DBAL 3.0.0 up to 3.1.3 to upgrade to 3.1.4
immediately. </p>
<p>The vulnerability can happen when unsanitized input is passed to many APIs in
Doctrine DBAL and ORM that ultimately end up calling
<code>AbstractPlatform::modifyLimitQuery</code>.</p>
<p>As a workaround you can cast all limit and offset parameters to integers before
passing them to Doctrine APIs.</p>
<p>This vulnerability has been assigned
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-43608">CVE-2021-43608</a>.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/05/24/orm2.9.html">New Release: Doctrine ORM 2.9 with Attributes, Typed Properties, more</a></h2>
        </header>

        <p class="lead">
            Posted on <date>May 24, 2021</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>We have released a new minor version 2.9 of Doctrine ORM, the first version
with support for using PHP 8 Attributes as a new driver for mapping entities
and several other changes. <a href="https://github.com/doctrine/orm/releases/tag/2.9.0">See all changes and contributors in the
Changelog</a> on Github.</p>
<h2>Attributes Mapping Driver</h2>
<p>The following code example shows many of the mappings that are re-using
the annotation classes for familiarity:</p>
<pre><code class="language-php">use Doctrine\DBAL\Types\Types;
use Doctrine\ORM\Mapping AS ORM;

#[ORM\Entity(repositoryClass: PostRepository::class)]
class Post
{
    #[ORM\Column(type: Types::INTEGER)]
    #[ORM\Id, ORM\GeneratedValue(strategy: 'AUTO')]
    private ?int $id;

    #[ORM\Column(type: Types::BOOLEAN)]
    private bool $published = false;

    #[ORM\Column(type: Types::SIMPLE_ARRAY)]
    private array $text = [];

    #[ORM\ManyToOne(targetEntity: User::class)]
    public $author;

    #[ORM\ManyToMany(targetEntity: Tag::class)]
    #[ORM\JoinTable(name: "post_tags")]
    #[ORM\JoinColumn(name: "post_id", referencedColumnName: "id")]
    #[ORM\InverseJoinColumn(name: "tag_id", referencedColumnName: "id")]
    public Collection $tags;
}</code></pre>
<h2>Typed Property Defaults</h2>
<p>Since PHP 7.4 types can be declared on class properties and Doctrine now
uses these type declarations to reduce amount of mapping boilerplate:</p>
<ul>
<li>Columns don't need the type definitions</li>
<li>ManyToOne and OneToOne don't need target entity definitions</li>
</ul>
<p>Example:</p>
<pre><code class="language-php">use Doctrine\ORM\Mapping AS ORM;

#[ORM\Entity(repositoryClass: UserRepository::class)]
class User
{
    #[ORM\Id, ORM\Column, ORM\GeneratedValue]
    public ?int $id = null;

    #[ORM\Column]
    public \DateTime $created;

    #[ORM\ManyToOne]
    public Email $email;
}</code></pre>
<h2>Psalmified APIs</h2>
<p>Improved the documentation to make sure static analysis tools and IDEs know
about the right entity classes returned from <code>EntityManager</code>,
<code>EntityRepository</code> and other public ORM APIs. This includes generics support
when you extend <code>EntityRepository</code>.</p>
<pre><code class="language-php">use Doctrine\ORM\EntityRepository;
use App\Entity\User;

/**
 * @template-extends EntityRepository&lt;User&gt;
 */
class UserRepository extends EntityRepository
{
}</code></pre>
<h2>Query::HINT_READ_ONLY</h2>
<p>A new query hint is added that allows hydrating entities through DQL that are
marked as read only for the unit of work session, as long as they are not yet
loaded as writeable:</p>
<pre><code class="language-php">$dql = 'SELECT u FROM ' . ReadOnlyEntity::class . ' u WHERE u.id = ?1';

$query = $entityManager-&gt;createQuery($dql);
$query-&gt;setParameter(1, $user-&gt;id);
$query-&gt;setHint(Query::HINT_READ_ONLY, true);

$user = $query-&gt;getSingleResult();</code></pre>
<h2>Index/UniqueConstraints using Field Names</h2>
<p>Instead of specifying column names for an index or unique-constraint declaration
you can now alternatively use field names.</p>
<pre><code class="language-php">
use Doctrine\ORM\Mapping AS ORM;

#[ORM\Entity]
#[ORM\Index(fields: ["isPublished"])]
class Post
{
    #[ORM\Column]
    public bool $isPublished = false;
}</code></pre>
<p>This simplifies mapping as the column names passed through the naming strategy
do not need to be known.</p>
<h2>INDEX BY Associations</h2>
<p>Previously DQL <code>INDEX BY</code> was not possible for assocations, now you can:</p>
<pre><code class="language-php">$dql = 'SELECT p, u FROM Post INDEX BY p.author JOIN p.author u WHERE p.id = 3';</code></pre>
<h2>Deprecations</h2>
<p>Doctrine ORM 2.9 rethinks deprecations and integrates with our new
<a href="https://github.com/doctrine/deprecations/">doctrine/deprecations</a> library.</p>
<ul>
<li>Undeprecate <code>merge()</code> and <code>detach()</code> as no replacements are available yet</li>
<li>Notify Persist Change Tracking: Use Explicit Change Tracking instead</li>
<li>DQL <code>SELECT PARTIAL</code> syntax, use Value Objects with <code>SELECT NEW</code> instead</li>
<li><code>EntityManager::flush()</code> with arguments</li>
<li><code>EntityManager::clear()</code> with arguments (use detach)</li>
<li>Named Queries in Mapping (use Repository)</li>
<li><code>cli-config.php</code> for console command configuration, inject <code>EntityManagerProvider</code> instead.</li>
<li>Deprecate <code>doctrine/cache</code> for metadata caching, use PSR-6 cache instead</li>
</ul>
<h2>Cache Deprecations and PSR-6</h2>
<p>Over the next versions we will deprecate use of doctrine/cache and replace it
with PSR-6. If you are still using doctrine/cache code in your own application
make sure to force the versions to &quot;^1.10&quot; in composer.json.
<a href="https://github.com/doctrine/cache/issues/354">Details</a></p>
<h2>PHP 7.1 Support</h2>
<p>ORM 2.9 reintroduces PHP 7.1 support, because it wasn't technically unsupported
anyways.  No changes were necessary to the code to allow it again except in the
testsuite.</p>
<p>The PHP 7.1 support was re-added to allow a very broad approach to prepare for
some of the deprecations that are introduced in ORM 2 and will be removed in
version 3.0.</p>
<h2>Coding Standard Support</h2>
<p>Doctrine ORM 2.9 now supports and fully validates against Doctrine Coding
Standard version 9.0+. This greatly improves automatic pull request checks as
all new violations in a PR get caught and inlined into the PR as comments.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/04/19/dbal-2.13.1-3.1.0.html">New Release: Doctrine DBAL 2.13.1 and 3.1.0 with important Forward Compatibility fix</a></h2>
        </header>

        <p class="lead">
            Posted on <date>April 19, 2021</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>Last month <a href="https://www.doctrine-project.org/2021/03/29/dbal-2.13.html">we released DBAL
2.13.0</a> as an
important push for the ecosystem towards DBAL 3 with an extensive deprecation
and forward compatibility layer.</p>
<p>We made a few mistakes, given that the forward compatibility layer is quite complex.
As such we have now released Doctrine DBAL 2.13.1 and 3.1.0 with two new APIs
that improve the forward compatiblity.</p>
<p>The problem lies in <code>Statement::execute()</code>: 2.13.0 would return a <code>bool</code> and
3.0.0 would return a <code>Result</code> from this method. This kind of API change cannot
be handled with a forward compatibility.</p>
<p>As such we introduced two new APIs on <code>Statement</code> that replace <code>execute()</code>.
When the old code was:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$statement-&gt;execute();

$rows = $statement-&gt;fetchAll();</code></pre>
<p>Then the new code is now:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$result = $statement-&gt;executeQuery();

$rows = $result-&gt;fetchAllAssociative();</code></pre>
<p>The DBAL 2.13 forward compatiblity layer supports both versions of all code and
returns a Statement/Result hybrid that has all the APIs that the DBAL Statement
had up until version 2.12. This way you can move at your own pace from the old
to the new API in your code.</p>
<p>Thank you again to <a href="https://github.com/mdumoulin">mdumoulin</a> for the work on
improving the forward compatiblity and to <a href="https://twitter.com/srgmrzv">Sergei Morozov</a>
for the thorough reviews and comments.</p>
<p>Again I want to highlight the Runtime Deprecations library that we introduced
to support this migration. You can integrate this with your log stack during
development and testing:</p>
<pre><code class="language-php">use Doctrine\Deprecations\Deprecation;
use Monolog\Logger;
use Monolog\Handler\StreamHandler;

$log = new Logger('doctrine');
$log-&gt;pushHandler(new StreamHandler('deprecations.log', Logger::INFO));

Deprecation::enableWithPsrLogger($log);</code></pre>
<p>Or alternatively using PHP's global error handler:</p>
<pre><code class="language-php">Deprecation::enableWithTriggerError();</code></pre>
<p>See the <a href="https://www.doctrine-project.org/2021/03/29/dbal-2.13.html">2.13 blog
post</a> for more
information about the migration to DBAL 3 and strategy recommendations.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2021/03/29/dbal-2.13.html">New Release: Doctrine DBAL 2.13 with Deprecations and Forward Compatibility</a></h2>
        </header>

        <p class="lead">
            Posted on <date>March 29, 2021</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>We have released DBAL 2.13, what we plan to be the last minor version in the 2.x family of Doctrine DBAL.
This release includes additional forward compatibility to DBAL 3 around
<code>Statement</code> and <code>Result</code> API and with an integration in our new
deprecations logging library.</p>
<p>In addition this DBAL release re-enables PHP 7.1 and 7.2 compatibility to give
as much flexibility as possible to everyone with forward compatibility.</p>
<h3>Statement and Result Forward Compatibility</h3>
<p>DBAL 3.0 extracts all fetch-methods from the <code>Statement</code> API and moved them
to a new <code>Result</code> API that is returned from <code>Statement::execute</code>. We have
backported this API to 2.13 - so that you can support writing code for both
DBAL 2 and 3 at the same time.</p>
<p>Old code:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$statement-&gt;bindParam(1, $value);
$statement-&gt;execute();

while (($row = $statement-&gt;fetch()) !== false) {
}

$connection-&gt;executeQuery('SELECT * FROM tbl')-&gt;fetchAll();</code></pre>
<p>New Code:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$statement-&gt;bindParam(1, $value);
$result = $statement-&gt;executeQuery();

while (($row = $result-&gt;fetchAssociative()) !== false) {
}

$connection-&gt;executeStatement('SELECT * FROM tbl')-&gt;fetchAllAssociative();</code></pre>
<p>The Result Fetching API was improved to use more human-readable names:</p>
<pre><code class="language-php">// Old
$stmt-&gt;fetch();
$stmt-&gt;fetch(PDO::FETCH_ARRAY);
$stmt-&gt;fetchColumn();
$stmt-&gt;fetchAll();

// New
$result = $stmt-&gt;execute();
$result-&gt;fetchAssociative();
$result-&gt;fetchNumeric();
$result-&gt;fetchOne();
$result-&gt;fetchAllAssociative();</code></pre>
<p>Many more changes have been made on the public API and also for the internals,
but these are the most common ones.</p>
<p>Thank you to <a href="https://github.com/mdumoulin">mdumoulin</a> for the work on
improving the forward compatiblity.</p>
<h3>Deprecations Logging</h3>
<p>We have wrestled internally for a long time with the strategy on runtime
deprecation going forward and settled on introducing a small, new API for
reporting the usage of deprecated APIs.</p>
<p>The reason for this abstraction is the potential for side effects caused by an
error handler and the potential overhead. We expect our deprecations to be
triggered a few hundred times in some requests as such the production overhead
must be minimal. </p>
<p>This means deprecation logging is disabled by default and you must enable
it to either use <code>@trigger_error</code> or a PSR-3 compatible logger.</p>
<p>See the <a href="https://github.com/doctrine/deprecations/">deprecation library
README.md</a> for details on how to
configure and use it.</p>
<h3>PHP 7.1 and 7.2 Support</h3>
<p>A few large Doctrine DBAL deployments still support older versions of PHP that
are not officially supported anymore, but are covered by support of a few Linux
distributions.</p>
<p>To provide the largest possible flexibility to the ecosystem to run code with
both DBAL 2 or 3 this version of Doctrine DBAL will work again with PHP 7.1 and
7.2</p>
<h3>Migrate to DBAL 3</h3>
<p>We recommend a three step strategy to move your code-base and that of your
dependents to DBAL 3. It depends if you are working on a library or
platform that is dependent upon, or if you are working on a standalone application.</p>
<p>For a standalone application:</p>
<ol>
<li>Upgrade to DBAL 2.13 and enforce &quot;^2.13&quot; as a version constraint in
composer.json</li>
<li>Enable deprecation tracking and eliminate all deprecations triggered in your
codebase.</li>
<li>After fixing all deprecations, update composer constraint to &quot;^3.0&quot;.
Doctrine will upgrade to version 3 if all other dependencies you are using
are ready as well to upgrade to version 3. If it fails, you need to identify
and update the dependencies as well.</li>
</ol>
<p>For a library, framework or platform:</p>
<ol>
<li>Upgrade to DBAL 2.13 and enforce &quot;^2.13&quot; as a version constraint in
composer.json</li>
<li>Enable deprecation tracking and eliminate all deprecations triggered in your
codebase. Release a version so that all plugins and downstream users
can be notified of using deprecated Doctrine DBAL directly themselves.</li>
<li>After fixing all deprecations, update composer constraint to &quot;^2.13 | ^3.0&quot;.
Doctrine will only upgrade to version 3 if all other dependencies you are
using are ready as well to upgrade to version 3.</li>
</ol>
<p>We recommend the following strategies to detect the use of deprecated code:</p>
<ul>
<li>Use Psalm, other static analyzers or IDEs to detect the use of deprecated code.</li>
<li>If you have an extensive test-suite, register a PSR-3 logger with Doctrine
Deprecations to catch all deprecations while running the tests.</li>
<li>Otherwise register a PSR-3 logger with Doctrine Deprecations in development
or staging only and collect and fix them as well you can. This could be
done for a longer amount of time of days, weeks or months.</li>
<li>If that is not possible, register a PSR-3 logger in production. Make sure to
eliminate high frequency deprecations quickly or call <code>ignoreDeprecation</code> to
snooze them to avoid overhead.</li>
</ul>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2020/11/17/dbal-3.0.0.html">New Major Release: Doctrine DBAL 3.0</a></h2>
        </header>

        <p class="lead">
            Posted on <date>November 17, 2020</date>
                            by
                                    <a href="mailto:kontakt@beberlei.de">Benjamin Eberlei</a>
                                    </p>

        <hr />

        <div>
            <p>We have released a new major version of Doctrine DBAL, version 3.0.0. This new
major version comes almost 10 years after DBAL 2.0 was released on December
2010, then coupled into the ORM 2.0.</p>
<p>Today Doctrine DBAL is released independent of the ORM, thanks to Composer and
sees its new major version before the ORM.</p>
<p>This release was made possible foremost by
<a href="https://twitter.com/srgmrzv">Sergei Morozov</a>, our primary DBAL maintainer, who has
spent countless hours working on the package since 2016. Thank you!</p>
<p>See the <a href="https://github.com/doctrine/dbal/releases/tag/3.0.0">Release Notes</a>
for a detailed list of changes.</p>
<p>This blog post covers a few of the major changes in a bit more detail to give
you an idea of what DBAL 3.0 looks like.</p>
<h3>Decouple DBAL from PDO</h3>
<p>The major theme of DBAL 3.0 is the decoupling from PDO. Instead of copying the
API verbatim like DBAL 2.0 did, DBAL 3.0 grows it into a better, more usable
direction.</p>
<p>We extract all fetch-methods from the <code>Statement</code> class and moved them to a new
<code>Result</code> class that is returned from <code>Statement::execute</code>.</p>
<p>Old code:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$statement-&gt;bindParam(1, $value);
$statement-&gt;execute();

while ($row = $statement-&gt;fetch()) {
}</code></pre>
<p>New Code:</p>
<pre><code class="language-php">$statement = $connection-&gt;prepare('SELECT * FROM tbl WHERE col = ?');
$statement-&gt;bindParam(1, $value);
$result = $statement-&gt;execute();

while ($row = $result-&gt;fetchAssociative()) {
}</code></pre>
<p>The Result Fetching API was improved to use more human-readable names:</p>
<pre><code class="language-php">// Old
$stmt-&gt;fetch();
$stmt-&gt;fetch(PDO::FETCH_ARRAY);
$stmt-&gt;fetchColumn();
$stmt-&gt;fetchAll();

// New
$stmt-&gt;fetchAssociative();
$stmt-&gt;fetchNumeric();
$stmt-&gt;fetchOne();
$stmt-&gt;fetchAllAssociative();</code></pre>
<p>Many more changes have been made on the public API and also for the internals,
but these are the most visible ones.</p>
<h3>Upgrading to DBAL 3 from 2</h3>
<p>DBAL 3 is a real new major release with significant changes to the public API. Depending
on your codebase a migration could require non-trivial work. However we do not intend
to leave you hanging with DBAL 2 and a future migration:</p>
<ol>
<li>
<p>We intend to support DBAL 2.12 a while longer, including support for the
upcoming PHP 8.0, so that there is no rush for you to upgrade to DBAL 3.</p>
</li>
<li>
<p>DBAL 2.12 already includes forwards compatible API changes for all the new APIs,
so that you can migrate your code step by step to the new APIs already.</p>
</li>
<li>
<p>Deprecated methods in DBAL 2.12 are tagged with the <code>@deprecated</code> doc-block
and static analysis tools such as Psalm, PHPStan and Phan can already help
you detect using or calling this deprecated code in your application.</p>
</li>
<li>
<p>We intend to release another version of DBAL 2 which includes
optional triggering of deprecation messages at runtime similar to how Symfony
deals with deprecations.</p>
</li>
</ol>
<p>As you can see, with these approaches it will be possible for you to smoothly migrate
your application from DBAL 2 to 3.</p>
<p>As a note to libraries and frameworks that need to support multiple versions of
Doctrine DBAL: We recommend you start out with DBAL 2.12 and migrate all usages
of deprecated APIs to their newer counterparts. Then once you have managed
this, you can allow 3.0 and try to get your code working with both versions.
Unfortunately this may not be possible for all cases, because we could not
provide replacement APIs for everything and some features have been dropped
between DBAL 2 and 3.</p>
<h3>Outlook</h3>
<p>DBAL 3 is a huge first step towards a modern database abstraction layer,
independent from the legacy of PHP and PDO API design. In the future we plan to
improve DBAL in other ways that we haven't gotten around yet, such as more API
modernization, increased safety with use of strict scalar types in the code
base, better error handling and more.</p>
        </div>
    </article>
    <article>
        <header>
            <h2><a href="/2020/04/10/doctrine-migrations-3.0.html">Released doctrine/migrations 3.0-alpha</a></h2>
        </header>

        <p class="lead">
            Posted on <date>April 10, 2020</date>
                            by
                                    <a href="mailto:goetas@gmail.com">Asmir Mustafic</a>
                                    </p>

        <hr />

        <div>
            <p><a href="https://github.com/doctrine/migrations"><code>doctrine/migrations</code> 3.0-alpha</a>
has been <a href="https://github.com/doctrine/migrations/tree/3.0.0-alpha1">published</a> on the 29th March 2020. </p>
<p>The upcoming 3.0 new major release is the result of almost 6 months of work and brings
a completely refactored/rewritten internal structure and some interesting new features.  </p>
<h3>Why a new major release?</h3>
<p>The <code>doctrine/migrations</code> <code>v1.x</code> codebase is 10 years old, and in the past years a lot of features have been added on top of its
initial architecture.<br />
<code>doctrine/migrations</code> <code>2.0</code> was released a bit more than a year ago. This major release did a bit of cleanup,
but the general structure remained the same.
In this schema you can see the dependencies between classes in the latest <code>2.3.x</code> branch:</p>
<div class="text-center">
<object width="70%" data="/images/posts/doctrine-migrations-3.0/complex-cycle-v2.svg" type="image/svg+xml"></object>
</div>
<p>The red lines are circular dependencies (and we already know that in software development circular dependencies are not
a good thing).</p>
<p>In <code>doctrine/migrations</code> <code>3.x</code>, most of the internal classes have been re-written and dependency injection has been
widely adopted.<br />
In this schema you can see the dependencies between classes in the latest <code>master</code> branch (release v3.0):</p>
<div class="text-center">
<object width="70%" data="/images/posts/doctrine-migrations-3.0/complex-cycle-v3.svg" type="image/svg+xml"></object>
</div>
<p>As you can see the circular dependencies are gone. This has been possible thanks to extensive use of dependency injection
and applying SOLID principles.
To reduce future backward incompatibilities, many classes have been marked as <code>final</code> or as <code>@internal</code> while
keeping the functionalities intact. Extensibility is still possible by using dependency injection and providing
classes implementing dedicated interfaces.</p>
<p><em>These schemas have been generated using <a href="https://github.com/mamuz/PhpDependencyAnalysis">PhpDependencyAnalysis</a>
with <a href="https://gist.github.com/goetas/e6343746a6ccd6ebb191cbbd675898e0">this configuration</a>.</em></p>
<h3>New features and improvements</h3>
<p>Beside the code quality improvements, there is a a long list of improvements (see below), but
<strong>the main user-facing feature is the ability to collect migrations from multiple folders/namespaces and
to specify dependencies between migrations.</strong></p>
<p>Here a (probably not complete) list of improvements implemented in the upcoming <code>3.0</code> release: </p>
<ul>
<li>ability to collect migrations from multiple folders/namespaces and to specify dependencies between migrations</li>
<li><code>doctrine/migrations</code> will write to your database only when running migrations
(previously the metadata table was created on the very first command run even if it was a read-only command)</li>
<li>Output verbosity can be controlled using the <code>-v</code>, <code>-vv</code> or <code>-vvv</code> command parameters</li>
<li>Use of dependency injection allows you to decorate/replace most services</li>
<li>Removed usage of console helpers to provide the connection or entity manager in favor of dependency injection</li>
<li>Introduced <code>migrations:list</code> command to list the available/executed migrations</li>
<li>Introduced <code>migrations:sync-metadata-storage</code> command to explicitly update the metadata schema in case a newer version
introduces changes to the metadata table</li>
<li>Multiple migrations can be passed to the <code>migrations:execute</code> command</li>
<li>More organized output of the <code>migrations:status</code> command</li>
<li>Configurations and Dependency Factory are read-only during the migration process</li>
<li>The <code>down()</code> migration is optional now</li>
<li>Multi-namespace migrations</li>
<li>Custom migrations metadata storage</li>
<li>Added warning when using the <code>migrations:diff</code> if there are not executed migrations</li>
</ul>
<h3>Backward compatibility</h3>
<p>In <code>doctrine/migrations</code> <code>3.0</code> a lot of things changed, but for end-users most of the things will look the same.
Your migration files do not need any update.</p>
<p>You will have to change  your configuration files, as the configuration format has changed.
The <a href="https://www.doctrine-project.org/projects/doctrine-migrations/en/latest/reference/configuration.html#configuration">official documentation</a> contains more information about these changes.
This documentation should be particularly helpful if you did also some custom integration with third party frameworks
or libraries.</p>
<p>If you wrote custom event listeners, please take a look at them as the method signatures for event listeners have been updated.</p>
<h3>Symfony Integration</h3>
<p>If you are using <a href="https://github.com/doctrine/DoctrineMigrationsBundle">DoctrineMigrationsBundle</a> then things are even
easier: the 2.3.0 release introduced some deprecation notices and if you have already solved them
your configuration is already compatible. If you want you can have a look to the latest configuration format
available on the <a href="https://www.doctrine-project.org/projects/doctrine-migrations-bundle/en/3.0/index.html#configuration">official documentation</a>.
You can look more in detail to which changes are needed in the <a href="https://github.com/doctrine/DoctrineMigrationsBundle/blob/master/UPGRADE.md">upgrading</a> document.</p>
<h3>What is next</h3>
<p>In the upcoming weeks, we will be preparing the first beta release and starting the process to reach a stable release.
<strong>To be able to deliver a good stable release it is important that you test the pre-release and share your feedback!</strong></p>
<p>To try the alpha version, you can run:</p>
<pre><code class="language-bash">composer require 'doctrine/migrations:^3.0@alpha'</code></pre>
<p>If you are using Symfony: </p>
<pre><code class="language-bash">composer require 'doctrine/doctrine-migrations-bundle:^3.0@alpha' 'doctrine/migrations:^3.0@alpha'</code></pre>
<p>You can be also more brave trying the development versions by specifying <code>@dev</code> instead of <code>@alpha</code>
when requiring the composer dependencies above.</p>
<p>You can also have a look at the <a href="https://github.com/doctrine/migrations/releases/tag/3.0.0-alpha1">release notes</a>
and the <a href="https://github.com/doctrine/migrations/blob/3.0.0-alpha1/UPGRADE.md">upgrading</a> document.</p>
<p>Similarly you can also have a look at the <a href="https://github.com/doctrine/DoctrineMigrationsBundle/releases/tag/3.0.0-alpha.1">release notes</a>
and the <a href="https://github.com/doctrine/DoctrineMigrationsBundle/blob/3.0.0-alpha.1/UPGRADE.md">upgrading</a> document for the Symfony bundle.</p>
<p>In the alpha release, breaking changes are still possible.
In the beta, release breaking changes are possible but will happen
only if we will find very unexpected behaviors.
When the alpha and beta phase will be completed, a stable version will be made available. </p>
<h2>Note</h2>
<p>This post was initially published on <a href="https://www.goetas.com/blog/released-doctrinemigrations-30-alpha/">https://www.goetas.com/blog/released-doctrinemigrations-30-alpha/</a>.</p>
        </div>
    </article>

<a href="/blog/archive.html" class="btn btn-primary">View Blog Archive</a>
            </main>

        <button id="back-to-top" title="Go to top">Top</button>

                    <footer class="footer">
                <div class="container">
                    <ul class="list-inline">
                        <li class="list-inline-item"><a href="/projects.html">Projects</a></li>
                        <li class="list-inline-item"><a href="/partners.html">Partners</a></li>
                        <li class="list-inline-item"><a href="/sponsorship.html">Sponsorship</a></li>
                        <li class="list-inline-item"><a href="/community/index.html">Community</a></li>
                        <li class="list-inline-item"><a href="/blog/index.html">Blog</a></li>
                        <li class="list-inline-item"><a href="/events.html">Events</a></li>
                        <li class="list-inline-item"><a href="/consulting.html">Consulting</a></li>
                    </ul>
                </div>
            </footer>
        
        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script
            src="https://www.doctrine-project.org/frontend/js/bundle.js?e690ec"
                            integrity="sha384-HlquHHnsk57fOpIpNpH5aTJexhmiFWe5VxXE0QVH7gUjNSFr8HSaSFq1lqEAuxEr"
                        crossorigin="anonymous">
        </script>

                
        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            var searchBoxSettings = {
                container: '#search-box',
                placeholder: 'Search'
            };

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }
        </script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
            <script
            src="https://www.doctrine-project.org/frontend/js/prismjs.js?734bad"
                            integrity="sha384-grLp9fRZF9gNTw6swxS6JSeblMyLpeDp3W9l0GYdH5T0jL4TphypaBu78dmD19jZ"
                        crossorigin="anonymous">
    </script>
    </body>
</html>
