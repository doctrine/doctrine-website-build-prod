<!DOCTYPE html>
<html>
    <head>
        <title>Blog - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://www.doctrine-project.org/css/style.css?aabb96" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://www.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/blog/page/61.html" />
        <meta property="og:title" content="Blog - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://www.doctrine-project.org/"><img src="https://www.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://www.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/coding-standard.html">Coding Standard</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/persistence.html">Persistence</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/reflection.html">Reflection</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://www.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://www.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://www.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>
            </nav>

            <div class="search-results rounded">
                <div id="hits">
                    <!-- Hits widget will appear here -->
                </div>

                <a href="https://www.algolia.com" target="_blank"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
            </div>
        
            <main role="main" class="container-wrapper container">
                        <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2009/08/22/transactions-and-performance.html">Transactions and Performance</a></h2>
        </header>

        <p class="lead">
            Posted on 2009-08-22
                            by
                                    romanb
                                    </p>

        <hr />

        <div>
            <p>In this post I want to clarify some things about transactions and
performance of PHP applications in general. I want to show you that it
is very easy to lose a lot of performance without using any "heavy"
framework at all and I also want to show that frameworks can actually
help you avoid a lot of these problems transparently. I want to
sensibilize you for the fact that there are a lot of factors in PHP
application performance and that you can very easily lose the
performance that you hoped to gain by not using framework X or Z or
building your own ("Not Invented Here"-syndrome) by several orders of
magnitude through rather trivial errors or misconceptions.</p>

<p>Given a MySql database with InnoDB tables, which of the following code
snippets that insert 20 users do you think is faster? First the Doctrine
(2) version:</p>

<pre><code class="sourceCode php">&lt;?php
// Using Doctrine 2 to insert 20 users
for ($i=0; $i&lt;20; ++$i) {
    $user = new CmsUser;
    $user-&gt;name = 'Guilherme';
    $user-&gt;status = 'Slave';
    $user-&gt;username = 'gblanco';
    $em-&gt;persist($user);
}

$s = microtime(true);
$em-&gt;flush();
$e = microtime(true);
echo ($e - $s) . "&lt;br/&gt;";
</code></pre>

<p>Now the good old mysql&#95;query version:</p>

<pre><code class="sourceCode php">&lt;?php
$s = microtime(true);
for ($i=0; $i&lt;20; ++$i) {
    mysql_query("INSERT INTO cms_users (name, status, username) VALUES ('Guilherme', 'Slave', 'gblanco')", $link);
}
$e = microtime(true);
echo ($e - $s) . "&lt;br/&gt;";
</code></pre>

<p>Even this comparison is not fair since flush() is doing a lot more stuff
but anyhow. The results might surprise some of you:</p>

<pre><code>Doctrine 2: 0.0094 seconds
mysql_query: 0.0165 seconds
</code></pre>

<p>Yes, our good old mysql&#95;query code is almost twice as slow even though
it does a lot less, provides no features, no abstraction, no basic
protection against SQL injection, etc. Why is that? The answer is:
transactions. In the Doctrine 2 example, Doctrine takes over transaction
management for us and efficiently executes all inserts in a single,
short transaction. In the plain mysql&#95;query example, there is no
transaction demarcation and since MySql by default operates in
autocommit mode, every mysql&#95;query call will implicitly commit the
transaction and start a new one. Thats 20 transactions. Here is the
revised code of the second example with proper transaction demarcation:</p>

<pre><code class="sourceCode php">&lt;?php
$s = microtime(true);
mysql_query('START TRANSACTION', $link);
for ($i=0; $i&lt;20; ++$i) {
    mysql_query("INSERT INTO cms_users (name, status, username) VALUES ('Guilherme', 'Slave', 'gblanco')", $link);
}
mysql_query('COMMIT', $link);
$e = microtime(true);
echo ($e - $s) . "&lt;br/&gt;";
</code></pre>

<p>The result:</p>

<pre><code>mysql_query: 0.0028 seconds
</code></pre>

<p>Thats a huge difference. We can conclude:</p>

<p><strong>Bad or no transaction management/demarcation can reduce performance by
several orders of magnitude.</strong></p>

<p>Many people are used to autocommit mode without really being aware of
what it is doing. It does not mean there is no transaction unless you
issue START/BEGIN TRANSACTION or PDO&#35;beginTransaction(). It means after
every single query a transaction is committed automatically and a new
one started. Methods like PDO&#35;beginTransaction() merely suspend
autocommit mode for a short duration (until you call
PDO&#35;commit()/PDO&#35;rollback()).</p>

<p>To clarify:</p>

<p><strong>You can not talk to your database outside of a transaction.</strong></p>

<p>Even SELECT queries get wrapped in a small transaction in autocommit
mode. However since SELECT statements usually don't result in any write
locks (like INSERT/UPDATE/DELETE) the penalty of these transactions is
usually not that big.</p>

<p>Doctrine 2 can help a lot here. You can modify your objects anywhere,
persist and delete objects anywhere and once you call
<code>EntityManager#flush()</code> Doctrine 2 will efficiently make all updates in
a single transaction.</p>

<p>What I wanted to highlight with this post is that there are a lot of
factors that influence the performance of your application, and raw
execution speed of the code is certainly not one of the most influential
ones. You can very easily lose 10 times the performance by trivial
things such as the one shown above (bad/no transaction demarcation) than
what you gained by choosing some "ultra lightweight" PHP framework or a
homegrown solution.</p>

<p>There are many more factors, like network load, inefficient database
indices or no indices, and much more. Don't just always look at the raw
execution speed of your code. Use code that is well tested, established,
used by lots of people and developed by lots of people. Don't reinvent
the wheel and use existing tools or help make existing tools better!
(Oh, and use the right tool for the job, of course!)</p>

<p>Most of the time when you think your own solutions are much better and
have a lot less bugs than existing ones then thats most likely just
because noone else is using it and so the bugs are never found :-).</p>

<p>PS: If you're still confused by the autocommit mode, let me recommend
this excellent page from the Hibernate project: <a href="https://www.hibernate.org/403.html">Non-transactional data
access and the auto-commit mode</a></p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2009/08/15/doctrine2-native-queries.html">Doctrine 2 Native Queries</a></h2>
        </header>

        <p class="lead">
            Posted on 2009-08-15
                            by
                                    romanb
                                    </p>

        <hr />

        <div>
            <p>If you are familar with Doctrine&#95;RawSql from Doctrine 1.x you probably
know that it is somewhat broken by design since it requires a special
syntax in the select clause that makes a lot of SQL constructs in the
select clause impossible.</p>

<p>Doctrine 2 introduces a facility called "native queries", represented by
the <code>Doctrine\ORM\NativeQuery</code> class that replaces Doctrine&#95;RawSql. The
clue about NativeQuery is that it allows the usage of real native SQL
yet the result can be transformed into all the different formats that
are supported by DQL.</p>

<p>This is achieved through having a generic description of how an SQL
result maps to a Doctrine result in form of a
<code>Doctrine\ORM\Query\ResultSetMapping</code>.</p>

<p>Enough of the introductory talk, lets look at a (primitive) example from
our test suite:</p>

<pre><code class="sourceCode php">&lt;?php
$rsm = new ResultSetMapping;
$rsm-&gt;addEntityResult('Doctrine\Tests\Models\CMS\CmsUser', 'u');
$rsm-&gt;addFieldResult('u', 'id', 'id'); // ($alias, $columnName, $fieldName)
$rsm-&gt;addFieldResult('u', 'name', 'name'); // // ($alias, $columnName, $fieldName)

$query = $this-&gt;_em-&gt;createNativeQuery('SELECT id, name FROM cms_users WHERE username = ?', $rsm);
$query-&gt;setParameter(1, 'romanb');

$users = $query-&gt;getResult();

$this-&gt;assertEquals(1, count($users));
$this-&gt;assertTrue($users[0] instanceof CmsUser);
$this-&gt;assertEquals('Roman', $users[0]-&gt;getName());
</code></pre>

<p>The SQL that is passed to createNativeQuery is not touched by Doctrine
in any way. The NativeQuery and ResultSetMapping combination are
extremely powerful. It might not surprise you that Doctrine 2 creates a
ResultSetMapping internally when it transforms DQL to SQL.</p>

<p>Granted, this was a very trivial example that can easily be expressed in
a short DQL 1-liner but it was just for demonstration purposes (and I am
bad at making up complex ad-hoc SQL examples that make sense).</p>

<p>So when is this useful? While DQL has been heavily improved in Doctrine
2 and has many new powerful features which we will cover in future blog
posts, it is sometimes necessary to use native SQL. NativeQuery gives
you the ability to do that while still retrieving the results in the
convenient Doctrine formats you are familar with. NativeQuery is also an
obvious choice when starting to migrate a pure SQL project to Doctrine
without going into all the DQL details from the start.</p>

<p>More on NativeQuery and ResultSetMapping can be found in the new
documentation under:</p>

<p><a href="http://www.doctrine-project.org/documentation/manual/2_0/en/native-sql">Documentation - Native
Sql</a></p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2009/08/07/doctrine2-batch-processing.html">Doctrine 2 Batch Processing</a></h2>
        </header>

        <p class="lead">
            Posted on 2009-08-07
                            by
                                    romanb
                                    </p>

        <hr />

        <div>
            <dl>
<dt><strong>TIP</strong> Disclaimer: In general, an ORM is surely not the best tool</dt>
<dd>
<p>for the job for mass data movements, however, it can be a convenient
alternative if the performance is sufficient. Every RDBMS has its
own highly efficient commands for such operations. For maximum
efficiency you should consult the manual of your RDBMS.</p>

<p><strong>NOTE</strong> The hardware used for the following tests: MBP, Intel Core
2 Duo 2.53 Ghz, 4GB DDR3 RAM, 7200rpm HDD.</p>
</dd>
</dl>

<p>A lot of people have encountered the infamous "memory exhausted" errors
when using Doctrine for bulk operations or in long-running scripts. This
is a problem that is the result of 2 things:</p>

<ul>
<li>The often unnecessarily intertwined architecture of Doctrine 1.x.</li>
<li><p>The simple garbage collector of PHP \&lt; 5.3.</p>

<blockquote>
  <p><strong>NOTE</strong> If you did not know it yet, basically every circular
  reference between objects (and that is every bidirectional
  relationship!) is a potential memory leak in PHP \&lt; 5.3.</p>
</blockquote></li>
</ul>

<p>Now, the PHP team did their homework and introduced a new garbage
collector in PHP 5.3 (that is enabled by default, thank god!) that is
capable of properly detecting cyclic references that are not referenced
any longer from the outside.</p>

<p>In Doctrine 2 we did our part of the homework to address this issue and
redesigned the Doctrine core from scratch. The result is a much better
user experience, as I will demonstrate with some examples.</p>

<h1 id="mass-inserts">Mass inserts</h1>

<p>The first thing we will look at is mass inserts. In Doctrine 2 there is
a special pattern that can be used for mass inserts that looks as
follows:</p>

<pre><code class="sourceCode php">&lt;?php
// $em instanceof EntityManager
$batchSize = 20;
for ($i=1; $i&lt;=10000; ++$i) {
     $obj = new MyEntity;
     $obj-&gt;setFoo('...');
     // ... set more data
     $em-&gt;persist($obj);
     if (($i % $batchSize) == 0) {
         $em-&gt;flush();
         $em-&gt;clear();
    }
}
</code></pre>

<p>I used this pattern to create a little demonstration that looks like
this in a PHPUnit test:</p>

<pre><code class="sourceCode php">&lt;?php
// $this-&gt;_em created in setUp()
echo "Memory usage before: " . (memory_get_usage() / 1024) . " KB" . PHP_EOL;
$s = microtime(true);
$batchSize = 20;
for ($i=1; $i&lt;=10000; ++$i) {
     $user = new CmsUser;
     $user-&gt;status = 'user';
     $user-&gt;username = 'user' . $i;
     $user-&gt;name = 'Mr.Smith-' . $i;
     $this-&gt;_em-&gt;persist($user);
     if (($i % $batchSize) == 0) {
         $this-&gt;_em-&gt;flush();
         $this-&gt;_em-&gt;clear();
    }
}

//gc_collect_cycles(); // explained later!
echo "Memory usage after: " . (memory_get_usage() / 1024) . " KB" . PHP_EOL;

$e = microtime(true);
echo ' Inserted 10000 objects in ' . ($e - $s) . ' seconds' . PHP_EOL;
</code></pre>

<p>As you can see, we insert a total of 10000 objects. On running this code
through PHPUnit, using an SQLite in-memory database, I got the following
output:</p>

<pre><code>Memory usage before: 5034.03515625 KB
Memory usage after: 6726.3515625 KB
Inserted 10000 objects in 3.165983915329 seconds
</code></pre>

<p>We can see the following:</p>

<ul>
<li>The insertion of 10000 objects through Doctrine into an SQLite
in-memory database took roughly 3 seconds, not too bad.</li>
<li>Memory usage increased by roughly 1.7MB, not too bad either.</li>
</ul>

<p>If you are now still not satisfied and wonder where the 1.7MB are going,
here is the answer: A small part of that is occupied by objects that
were created on-demand internally by Doctrine, these will stay pretty
constant, however. But the majority of this 1.7MB has simply not yet
been reclaimed (but is eliglible for garbage collection for the new
garbage collector!). To prove that, I can just uncomment the
gc&#95;collect&#95;cycles() function call. Here's the result:</p>

<pre><code>Memory usage before: 5034.3828125 KB
Memory usage after: 5502.21484375 KB
Inserted 10000 objects in 3.1807188987732 seconds
</code></pre>

<p>Much better! And to prove that the \~500KB occupied by Doctrine are
constant, I simply made it 20000 objects. Here is the result:</p>

<pre><code>Memory usage before: 5034.3828125 KB
Memory usage after: 5502.21484375 KB
Inserted 20000 objects in 6.6149919033051 seconds
</code></pre>

<p>We can see the following things:</p>

<ul>
<li>Memory usage is constant, the second batch of 10000 objects did not
result in additional memory usage.</li>
<li>The mass insertion strategy scales almost linearly. 10k objects took
\~3.2 seconds and 20k objects took \~6.6 seconds.</li>
</ul>

<p>Note: You do not really need to call gc&#95;collect&#95;cycles(). This should
just demonstrate that the memory can be reclaimed. PHP would reclaim
that memory anyway when it needs to.</p>

<p>Even better, when testing the peak memory usage
(memory&#95;get&#95;peak&#95;usage()) it turned out that the memory usage never
grew beyond \~10MB in between. If you choose a larger batch size the
peak memory usage will be higher and vice versa.</p>

<h1 id="mass-object-processing">Mass object processing</h1>

<p>Now we take a look at mass-processing objects, which means loading 10000
objects from the database and doing something with each of them. The
clue here is the new support for iterative (step-by-step) hydration in
Doctrine 2. The pattern for these kinds of tasks looks as follows:</p>

<pre><code class="sourceCode php">&lt;?php
$q = $this-&gt;_em-&gt;createQuery("&lt;DQL to select the objects I want&gt;");
$iterableResult = $q-&gt;iterate();
while (($row = $iterableResult-&gt;next()) !== false) {
        // do stuff with the data in the row, $row[0] is always the object
        $this-&gt;_em-&gt;detach($row[0]); // detach from Doctrine, so that it can be GC'd immediately
 }
</code></pre>

<p>So instead of using <code>$q-&gt;execute()</code> or <code>$q-&gt;getResult()</code> or similar, we
use <code>$q-&gt;iterate()</code> which returns an instance of <code>IterableResult</code> that
allows us to iterate over the result step by step. The important part
for not running out of memory is the line where the created object is
detached from Doctrine, which results in Doctrine removing any internal
references to that object, Doctrine no longer "knows" about that object.</p>

<p>I used this pattern to iterate through the just inserted 10000 objects
as follows:</p>

<pre><code class="sourceCode php">&lt;?php
$q = $this-&gt;_em-&gt;createQuery("select u from Doctrine\Tests\Models\CMS\CmsUser u");
$iterableResult = $q-&gt;iterate();

echo "Memory usage before: " . (memory_get_usage() / 1024) . " KB" . PHP_EOL;

while (($row = $iterableResult-&gt;next()) !== false) {
    // ... I could do some stuff here
    $this-&gt;_em-&gt;detach($row[0]);
}

echo "Memory usage after: " . (memory_get_usage() / 1024) . " KB" . PHP_EOL;
</code></pre>

<p>The following is the result:</p>

<pre><code>Memory usage before: 6578.58984375 KB
Memory usage after: 6581.71875 KB
</code></pre>

<p>The result is pretty acceptable. Here is the same again, this time for
20000 objects, again to prove that the small memory increase is
constant:</p>

<pre><code>Memory usage before: 6578.23828125 KB 
Memory usage after: 6581.359375 KB
</code></pre>

<p>Good stuff!</p>

<blockquote>
  <p><strong>NOTE</strong> If you're thinking that I waited ages until the 10k or 20k
  objects were hydrated, that was not the case. 10k or 20k objects
  (without associations) are hydrated in seconds.</p>
</blockquote>

<p>More information on bulk operations with Doctrine 2 can be found in the
(very new) online manual that is still a work in progress:</p>

<p>http://www.doctrine-project.org/documentation/manual/2&#95;0/en/batch-processing</p>

<h1 id="update">UPDATE</h1>

<p>Some people seem to be wondering why Doctrine does not use multi-inserts
(insert into (...) values (...), (...), (...), ...</p>

<p>First of all, this syntax is only supported on mysql and newer
postgresql versions. Secondly, there is no easy way to get hold of all
the generated identifiers in such a multi-insert when using
AUTO&#95;INCREMENT or SERIAL and an ORM needs the identifiers for identity
management of the objects. Lastly, insert performance is rarely the
bottleneck of an ORM. Normal inserts are more than fast enough for most
situations and if you really want to do fast bulk inserts, then a
multi-insert is not the best way anyway, i.e. Postgres COPY or Mysql
LOAD DATA INFILE are several orders of magnitude faster.</p>

<p>These are the reasons why it is not worth the effort to implement an
abstraction that performs multi-inserts on mysql and postgresql in an
ORM.</p>

<p>I hope that clears up some questionmarks.</p>

        </div>

            </article>

    <nav class="mt-4">
        <ul class="pagination">
            <li class="page-item"><a class="page-link" href="https://www.doctrine-project.org/blog/page/60.html">Newer Posts</a></li><br />
            <li class="page-item"><a class="page-link" href="https://www.doctrine-project.org/blog/page/62.html">Older Posts</a></li>        </ul>
    </nav>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://www.doctrine-project.org/js/main.js?850a2b"></script>
        <script src="https://www.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
