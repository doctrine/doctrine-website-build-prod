<!DOCTYPE html>
<html>
    <head>
        <title>Blog - Doctrine - PHP Database Tools</title>

        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta name="description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
">

        <meta name="keywords" content="php,mysql,orm,dbal,database,mongodb,odm,annotations,migrations,cache,couchdb">

                    <meta name="robots" content="index, follow">
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" integrity="sha384-3AB7yXWz4OeoZcPbieVW64vVXEwADiYyAEhwilzWsLw+9FgqpyjjStpPnpBO8o8S" crossorigin="anonymous">

        <link href="https://www.doctrine-project.org/css/style.css?a4b3e9" rel="stylesheet" type="text/css" />

        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

        <link rel="stylesheet" href="https://www.doctrine-project.org/components/highlightjs/styles/railscasts.css?b4f8ae" />

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://www.doctrine-project.org/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.doctrine-project.org/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.doctrine-project.org/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.doctrine-project.org/images/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="https://www.doctrine-project.org/images/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.doctrine-project.org/images/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.doctrine-project.org/images/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.doctrine-project.org/images/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="https://www.doctrine-project.org/images/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="Doctrine"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="https://www.doctrine-project.org/images/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="https://www.doctrine-project.org/images/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="https://www.doctrine-project.org/images/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="https://www.doctrine-project.org/images/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="https://www.doctrine-project.org/images/mstile-310x310.png" />

        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@doctrineorm" />
        <meta name="twitter:creator" content="@doctrineorm" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://www.doctrine-project.org/blog/page/52.html" />
        <meta property="og:title" content="Blog - Doctrine - PHP Database Tools" />
        <meta property="og:description" content="The Doctrine Project is the home to several PHP libraries primarily focused on database storage and object mapping. The core projects are the Object Relational Mapper (ORM) and the Database Abstraction Layer (DBAL) it is built upon.
" />
        <meta property="og:image" content="https://www.doctrine-project.org/images/og.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="1200" />

        <link rel="alternate" type="application/atom+xml" href="https://www.doctrine-project.org/atom.xml" title="Doctrine activity feed" />

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "url": "https://www.doctrine-project.org",
            "logo": "https://www.doctrine-project.org/images/doctrine-logo.svg"
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "url": "https://www.doctrine-project.org",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://www.doctrine-project.org?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        }
        </script>

        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "Organization",
            "name": "Doctrine",
            "url": "https://www.doctrine-project.org",
            "sameAs": [
                "https://twitter.com/doctrineorm"
            ]
        }
        </script>

        
        
            </head>
    <body>
                    <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark flex-md-nowrap">
                <a class="navbar-brand text-hide" href="https://www.doctrine-project.org/"><img src="https://www.doctrine-project.org/images/doctrine-logo.svg?335f0f" />Doctrine</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://www.doctrine-project.org/projects.html" id="navbarProjectsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Projects
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarProjectsDropdown">
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/annotations.html">Annotations</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/cache.html">Cache</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/collections.html">Collections</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/common.html">Common</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/dbal.html">DBAL</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/event-manager.html">Event Manager</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/inflector.html">Inflector</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/lexer.html">Lexer</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/migrations.html">Migrations</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/mongodb.html">MongoDB</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/mongodb-odm.html">MongoDB ODM</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/orm.html">ORM</a>
                                                                    <a class="dropdown-item notranslate" href="https://www.doctrine-project.org/projects/phpcr-odm.html">PHPCR ODM</a>
                                                                <a class="dropdown-item bg-secondary text-white font-weight-bold" href="https://www.doctrine-project.org/projects.html">View All</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.doctrine-project.org/about/">About</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="https://www.doctrine-project.org/contribute/" id="navbarContributeDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>

                            <div class="dropdown-menu" aria-labelledby="navbarContributeDropdown">
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/">Contributor Workflow</a>
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/maintainer/">Maintainer Workflow</a>
                                <a class="dropdown-item" href="https://www.doctrine-project.org/contribute/website/">Contribute to Website</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.doctrine-project.org/community/">Community</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="https://www.doctrine-project.org/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://www.doctrine-project.org/team/">Team</a>
                        </li>
                    </ul>

                    <div class="google-translate-dropdown dropdown show d-inline-block mr-2">
                        <a class="btn btn-primary dropdown-toggle" href="#" role="button" id="translateDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Translate
                        </a>

                        <div class="dropdown-menu" aria-labelledby="translateDropdown">
                            <div class="dropdown-item" id="google_translate_element">Loading...</div>
                        </div>
                    </div>

                    <div id="search-box">
                        <!-- SearchBox widget will appear here -->
                    </div>
                </div>

                <div class="search-results rounded">
                    <div id="hits">
                        <!-- Hits widget will appear here -->
                    </div>

                    <a href="https://www.algolia.com" target="_blank"><img src="https://www.doctrine-project.org/images/search-by-algolia.png" class="float-right" style="width: 150px;" /></a>
                </div>
            </nav>
        
            <main role="main" class="container-wrapper container">
                        <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2010/02/24/doctrine2-versionable.html">A re-usable Versionable Behavior for Doctrine 2</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-02-24
                            by
                                    beberlei
                                    </p>

        <hr />

        <div>
            <dl>
<dt><strong>NOTE</strong> This blog entry relates to an outdated Doctrine 2 Alpha</dt>
<dd>version. Please see the documentation for the most up to date
behavior. A test-implementation for this behavior is on
github.com/beberlei/DoctrineExtensions</dd>
</dl>

<p>My previous post on behaviors in Doctrine 2 generated quite some
discussion about the difference on behaviours that are re-usable across
models and the trivial specific implementations I have shown.</p>

<p>In this post I will show a re-usable versionable (audit-log) behavior.
For this we will need the following ingredients:</p>

<ul>
<li>An interface <code>DoctrineExtensions\Versionable\Versionable</code></li>
<li>A class <code>DoctrineExtensions\Versionable\VersionManager</code></li>
<li>An event listener <code>DoctrineExtensions\Versionable\VersionListener</code></li>
<li><p>A generic entity <code>DoctrineExtensions\Versionable\ResourceVersion</code></p>

<blockquote>
  <p><strong>NOTE</strong> The Event API is currently in the central focus of our
  efforts so the API shown here may change before the first Beta
  release.</p>
</blockquote></li>
</ul>

<p>The workflow is as follows, each Entity that is supposed to be
versionable has to implement the interface <code>Versionable</code> which looks
like this:</p>

<pre><code class="sourceCode php">&lt;?php
namespace DoctrineExtensions\Versionable;

interface Versionable
{
    /**
     * @return int
     */
    public function getCurrentVersion();

    /**
     * @return array
     */
    public function getVersionedData();

    /**
     * @return int
     */
    public function getResourceId();
}
</code></pre>

<p>Whenever an entity is persisted or updated the state that is persisted
will also be logged in an audit table. The state is returned with an
array of key value pairs in the <code>getVersionedData()</code> and the current
version has to be the value of the @Version column of the entity.</p>

<p>To sum up, the requirements of an entity that can be a <code>Versionable</code> in
this simple implementation:</p>

<ul>
<li>Single Integer Primary Key.</li>
<li>Has to be versioned with an integer column.</li>
</ul>

<p>How does such versioned data look like? The generic resource version
entity looks like this. Its a Doctrine Entity, but in a domain model its
an immutable value object. It should not be changed after creation.</p>

<pre><code class="sourceCode php">&lt;?php
namespace DoctrineExtensions\Versionable;

class ResourceVersion
{
    /** @Id @Column(type="integer") */
    private $id;

    /** @Column(type="string") */
    private $resourceName;

    /** @Column(type="integer") */
    private $resourceId;

    /** @Column(type="array") */
    private $versionedData;

    /**
     * @Column(type="integer") */
    private $version;

    /** @Column(type="datetime") */
    private $snapshotDate;

    public function __construct(Versionable $resource)
    {
        $this-&gt;resourceName = get_class($resource);
        $this-&gt;resourceId = $resource-&gt;getResourceId();
        $this-&gt;versionedData = $resource-&gt;getVersionedData();
        $this-&gt;version = $resource-&gt;getCurrentVersion();
        $this-&gt;snapshotDate = new \DateTime("now");
    }

    // getters
}
</code></pre>

<p>Now we need to solve the problem of generating the <code>ResourceVersion</code>
whenever an <code>Versionable</code> entity is persisted or updated. This can be
done by using the <a href="http://www.doctrine-project.org/documentation/manual/2_0/en/events">Doctrine EventManager
API</a>.
We will implement the <code>EventSubscriber</code> interface and hook into the
"onFlush" event.</p>

<pre><code class="sourceCode php">&lt;?php
namespace DoctrineExtensions\Versionable;

use Doctrine\Common\EventSubscriber,
    Doctrine\ORM\Events,
    Doctrine\ORM\Event\OnFlushEventArgs,
    Doctrine\ORM\EntityManager;

class VersionListener implements EventSubscriber
{
    public function getSubscribedEvents()
    {
        return array(Events::onFlush);
    }

    public function onFlush(OnFlushEventArgs $args)
    {
        $em = $args-&gt;getEntityManager();
        $uow = $em-&gt;getUnitOfWork();

        foreach ($uow-&gt;getScheduledEntityInsertions() AS $entity) {
            if ($entity instanceof Versionable) {
                $this-&gt;_makeSnapshot($entity);
            }
        }

        foreach ($uow-&gt;getScheduledEntityUpdates() AS $entity) {
            if ($entity instanceof Versionable) {
                $this-&gt;_makeSnapshot($entity);
            }
        }
    }

    private function _makeSnapshot($entity)
    {
        $resourceVersion = new ResourceVersion($entity);
        $class = $this-&gt;_em-&gt;getClassMetadata(get_class($resourceVersion));

        $this-&gt;_em-&gt;persist( $resourceVersion );
        $this-&gt;_em-&gt;getUnitOfWork()-&gt;computeChangeSet($class, $resourceVersion);
    }
}
</code></pre>

<p>How do we hook this <code>VersionListener</code> into the EntityManager? We will
wrap the VersionManager around it that handles registration and offers
some convenience methods to retrieve the versions of a resource.</p>

<pre><code class="sourceCode php">&lt;?php
namespace DoctrineExtensions\Versionable;

use Doctrine\ORM\EntityManager;

class VersionManager
{
    private $_em;

    public function __construct(EntityManager $em)
    {
        $this-&gt;_em = $em;
        $this-&gt;_em-&gt;getEventManager()-&gt;addEventSubscriber(
            new VersionListener()
        );
    }

    public function getVersions(Versionable $resource)
    {
        $query = $this-&gt;_em-&gt;createQuery(
            "SELECT v FROM DoctrineExtensions\Versionable\ResourceVersion v INDEX BY v.version ".
            "WHERE v.resourceName = ?1 AND v.resourceId = ?2 ORDER BY v.version DESC");
        $query-&gt;setParameter(1, get_class($resource));
        $query-&gt;setParameter(2, $resource-&gt;getResourceId());

        return $query-&gt;getResult();
    }
}
</code></pre>

<p>Now using this to retrieve all the versions of a given entity that is
versionable you would go and:</p>

<pre><code class="sourceCode php">&lt;?php
// $em EntityManager, $blogPost my Blog Post

$versionManager = new VersionManager($em);
$versions = $versionManager-&gt;getVersions($blogPost);

echo "Old Title: ".$versions[$oldVersionNum]-&gt;getVersionedData('title');

// Create a new version
$blogPost-&gt;setTitle("My very new title");    
$em-&gt;flush();
</code></pre>

<p>This is a first example of how to use the powerful Doctrine 2 Event API.
It is certainly not easy to use, as you need to understand the inner
workings of the UnitOfWork and the different steps it is in during the
flush process. However you can generate huge benefits in reusability.</p>

<p>The versionable behaviour could be extended by the following features:</p>

<ul>
<li>Create a new interface <code>Revertable</code> that extends <code>Versionable</code> and
add a method <code>revert(Revertable $resource, $toVersion)</code> to the
<code>VersionManager</code> that handles the retrieval, invoking of revert and
such.</li>
<li>Create a new interface Diffable with a method diff(\$aVersion,
\$bVersion) and new method diff(Diffable \$resource, \$aId, \$bId)
to the VersionManager that handles the delegation of a difference
computation between two versions to the Diffable implementor.</li>
</ul>

<p>Another approach would be not to save the complete state of an entity
during the flush operation, but only the fields that changed. This is
generally called an <em>AuditLog</em>. We could add an <code>Auditable</code> interface
much in the same manner than the <code>Versionable</code> and retrieve the
ChangeSets of each entity during flush using the following event
listener:</p>

<pre><code class="sourceCode php">&lt;?php
class AuditListener implements EventSubscriber
{
    public function getSubscribedEvents()
    {
        return array(Events::onFlush);
    }

    public function onFlush(OnFlushEventArgs $args)
    {
        $em = $args-&gt;getEntityManager();
        $uow = $em-&gt;getUnitOfWork();

        $changeDate = new DateTime("now");
        $class = $em-&gt;getClassMetadata('DoctrineExtensions\Auditable\AuditEntry');

        foreach ($uow-&gt;getScheduledEntityUpdates() AS $entity) {
            if ($entity instanceof Auditable) {
                $changeSet = $uow-&gt;getEntityChangeSet($entity);

                foreach ($changeSet AS $field =&gt; $vals) {
                    list($oldValue, $newValue) = $vals;
                    $audit = new AuditEntry(
                        $entity-&gt;getResourceName(),
                        $entity-&gt;getId(),
                        $oldValue,
                        $newValue,
                        $changeDate
                    );

                    $em-&gt;persist($audit);
                    $em-&gt;getUnitOfWork()
                       -&gt;computeChangeSet($class, $audit);
                }
            }
        }
    }
}
</code></pre>

<p>This approach can also be re-used or combined with several similiar
behaviours, like Taggable, Blamable, Commentable.</p>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2010/02/18/symfony-live-2010.html">Symfony Live 2010</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-02-18
                            by
                                    jwage
                                    </p>

        <hr />

        <div>
            <p>This past week I had the pleasure of spending time in Paris, France for
the <a href="http://www.symfony-live.com">2010 Symfony Live</a> conference. My
first Symfony event was <a href="http://www.symfonycamp.com">Symfony Camp</a> in
2008 which was a great success. I also attended the first Symfony Live
last year where I spoke about <a href="http://www.sympalphp.org">Sympal</a> and
Doctrine. This time around the Symfony conference was an even bigger
success! The community around Symfony and Doctrine has grown a great
amount over the years and the event shows that! Many great speakers and
topics were present at the conference and it was very exciting to get to
be a part of it.</p>

<p>On the first day of the conference I was invited to speak about the
latest Doctrine 2! This is perfect timing as Fabien Potencier made
available the source code of <a href="http://www.symfony-reloaded.org">Symfony
2</a> the following day. I am very excited
about what the future holds for PHP in the coming years as Symfony 2 and
Doctrine 2 are really revolutionary PHP projects!</p>

<p>You can find the presentations given at the conference related to
Doctrine below:</p>

<ul>
<li><a href="http://www.slideshare.net/denderello/symfony-live-2010-using-doctrine-migrations">Using Doctrine
Migrations</a></li>
<li><a href="http://www.slideshare.net/jwage/doctrine-2-not-the-same-old-php-orm">Doctrine 2: Not the same Old PHP
ORM</a></li>
</ul>

        </div>

            </article>
    <article>
        <header>
            <h2><a href="https://www.doctrine-project.org/2010/02/17/doctrine2-behaviours-nutshell.html">Doctrine 2 &quot;Behaviours&quot; in a Nutshell</a></h2>
        </header>

        <p class="lead">
            Posted on 2010-02-17
                            by
                                    beberlei
                                    </p>

        <hr />

        <div>
            <dl>
<dt><strong>NOTE</strong> This blog entry relates to an outdated Doctrine 2 Alpha</dt>
<dd>version. Please see the documentation for the most up to date
behavior.</dd>
</dl>

<p>One of the most common fallacies out there about Doctrine 2 abandoning
Behaviours is that developers now have to implement fancy logic to
re-implement them yourself. Doctrine 2's approach to completly separate
ORM from your domain classes allows to build behaviours in a very clean,
unobstrusive and simple object-oriented way. This article shows you how
to implement some of the Doctrine 1 behaviours in your Doctrine 2 code.
For this I will rewrite the Doctrine 1.x manuals examples for each
Behaviour.</p>

<p>This example uses Annotations as example, yet this of course works with
YAML and XML mappings. Additionally Doctrine 2 allows constructors to
have required arguments as of a commit of the last week. This allows for
some pretty slick enforcements in user-land code as you will see in this
post.</p>

<h1 id="straightforward-combination-of-%22behaviours%22">Straightforward combination of "Behaviours"</h1>

<p>All the code listed below is somehwat more verbose than the Doctrine 1
code, however much more bound to the domain of your model and very
straightforward. There is no magic involved and you will fully
understand what will be happening in each of the behaviours. The best of
all, although not a simple trick, you will be able to combine ALL
behaviours in one model class and still be completly on top of their
inner workings.</p>

<h1 id="timestampable">Timestampable</h1>

<p>Timestampable is a behaviour that requires you to hook into the
pre-update event which is called whenever an entity is updated:</p>

<pre><code class="sourceCode php">&lt;?php
/**
 * @Id
 * @HasLifecycleCallbacks
 */
class BlogPost
{
    /**
     * @Column(type="DateTime")
     */
    private $created;

    /**
     * @Column(type="DateTime")
     */
    private $updated;

    public function __construct()
    {
        // constructor is never called by Doctrine
        $this-&gt;created = $this-&gt;updated = new DateTime("now");
    }

    /**
     * @PreUpdate
     */
    public function updated()
    {
        $this-&gt;updated = new DateTime("now");
    }
}
</code></pre>

<h1 id="sluggable">Sluggable</h1>

<p>The sluggable behaviour is trivial to implement in Doctrine 2:</p>

<pre><code class="sourceCode php">&lt;?php
class BlogPost
{
    /** @Column(type="string") */
    private $slug;

    /** @Column(type="string") */
    private $title;

    public function setTitle($title)
    {
        if ($this-&gt;slug == null) {
            $this-&gt;slug = MyStringHelper::slugize($title);
        }
        $this-&gt;title = $title;
    }

    /**
     * Put this method in if your slug should be "editable"
     */
    public function setSlug($slug)
    {
        $this-&gt;slug = $slug;
    }
}
</code></pre>

<p>See how its much more explicit in your code how and why the slug is
generated.</p>

<h1 id="nestedset">NestedSet</h1>

<p>This is one of the more complex behaviours in Doctrine 1 and it won't be
necessarily more easy in Doctrine 2. However as this is an important
feature we will provide an implementation as a <code>DoctrineExtensions</code>
namespaced package that will be maintained by Doctrine Devs.</p>

<h1 id="searchable">Searchable</h1>

<p>There is currently no plan to port the Searchable behaviour to Doctrine
2, but the possibility to instantiate objects using <em>new</em> allows a very
simple integration of a Doctrine 2 model with Apache Solr or Lucene with
a little wrapper that re-creates detached instances from this powerful
search engines.</p>

<p>For example using
<a href="http://ezcomponents.org/docs/api/trunk/introduction_Search.html">ezcSearch</a>
we can make our BlogPost accessible for Solr:</p>

<pre><code class="sourceCode php">&lt;?php
class BlogPost implements ezcBasePersistable, ezcSearchDefinitionProvider 
{
    public function getState()
    {
        return array(
            'id' =&gt; $this-&gt;id,
            'title' =&gt; $this-&gt;title,
            'body' =&gt; $this-&gt;body,
            'slug' =&gt; $this-&gt;slug,
        );
    }

    public function setState($state)
    {
        foreach ($state AS $k =&gt; $v) {
            $this-&gt;$k = $v;
        }
    }

    static public function getDefinition() 
    {
        // define search schema
        return $def;
    }
}
</code></pre>

<p>ezcSearch can then index a blog post whenever it is changed by hooking
an EventListener into the Doctrine <code>PreUpdate</code> Event:</p>

<pre><code class="sourceCode php">&lt;?php
class EzcSearchListener
{
    private $_searchSession;

    public function __construct(ezcSearchSession $searchSession)
    {
        $this-&gt;_searchSession = $searchSession;
    }

    public function preUpdate(LifecycleEventArgs $args)
    {
        if ($args-&gt;getEntity() instanceof ezcBasePersistable) {
            $this-&gt;_searchSession-&gt;index($args-&gt;getEntity());
        }
    }
}
</code></pre>

<p>You can now hook this event into Doctrine's EntityManager:</p>

<pre><code class="sourceCode php">&lt;?php
$searchListener = new EzcSearchListener(...);
$em-&gt;getEventManager()-&gt;addEventListener(
    array(Doctrine\ORM\Events::preUpdate), $searchListener
);
</code></pre>

<p>Now when you search for your entities you get returned <code>BlogPost</code>
instances from ezcSearchs Solr interface:</p>

<pre><code class="sourceCode php">&lt;?php
// initialize a pre-configured query
$q = $session-&gt;createFindQuery( 'BlogPost' );
$searchWord = 'test';

// where either body or title contains thr $searchWord
$q-&gt;where(
    $q-&gt;lOr(
        $q-&gt;eq( 'body', $searchWord ),
        $q-&gt;eq( 'title', $searchWord )
    )
);
$searchedBlogPosts = $session-&gt;find( $q ); 
</code></pre>

<p>These instances are detached from the EntityManager when they get
returned from ezcSearch and can be merged back into the persistence
context:</p>

<pre><code class="sourceCode php">&lt;?php
$searchedBlogPosts[0]-&gt;setTitle("ChangeFoo");
$em-&gt;merge($searchedBlogPosts[0]);
</code></pre>

<p>Read about Merging, Detached instances and other cool stuff of Doctrines
object model in the <a href="http://www.doctrine-project.org/documentation/manual/2_0/en/working-with-objects#merging-entities">Working with
Objects</a>
chapter of the manual.</p>

<h1 id="versionable">Versionable</h1>

<p>By default Doctrine 2 comes with a way to set a <em>version</em> column that is
automatically incremented on each update. Using the event system it is
easy to use this information to implement a versionable audit-log
behaviour. The required code is more verbose than the simple
configuration of Doctrine 1, however there is much less magic involved
and you can implement this behaviour in a way that is trivial to
understand for someone new looking at your code:</p>

<pre><code class="sourceCode php">&lt;?php
/**
 * @Entity
 * @HasLifeCycleCallbacks
 * @generatedValue(strategy="AUTO")
 */
class BlogPost
{
    /**
     * @Id
     * @Column(type="integer")
     */
    private $id;

    /**
     * @Column(type="string")
     */
    private $title;

    /**
     * @Column(type="text")
     */
    private $body;

    /**
     * @Column(type="integer")
     * @version
     */
    private $version;

    /**
     * @OneToMany(targetEntity="BlogPostVersion", mappedBy="post")
     */
    private $auditLog = array();

    /**
     * @PrePersist
     * @PreUpdate
     */
    public function logVersion()
    {
        $this-&gt;auditLog[] = new BlogPostVersion($this);  
    }
    // getters
}

/**
 * @Entity
 */
class BlogPostVersion
{
    /**
     * @Id
     * @Column(type="integer")
     * @generatedValue(strategy="AUTO")
     */
    private $id;

    /**
     * @Column(type="string")
     */
    private $title;

    /**
     * @Column(type="text")
     */
    private $body;

    /**
     * @Column(type="integer")
     */
    private $version;

    /**
     * @ManyToOne(targetEntity="BlogPost")
     */
    private $post;

    public function __construct(BlogPost $post)
    {
        $this-&gt;post = $post;
        $this-&gt;title = $post-&gt;getTitle();
        $this-&gt;body = $post-&gt;getBody();
        $this-&gt;version = $post-&gt;getCurrentVersion();       
    }
}
</code></pre>

<h1 id="i18n">I18N</h1>

<p>Multi-Language content is an important topic and can be implemented in
Doctrine 2, since its just a fancy name for a One-To-Many relation.
However currently Doctrine 2 does not allow to persist keys by name,
which makes a OneToMany implementation a bit more intensive then it
could be. We plan to implement primitive value collections however which
would simplify any attempt to implement nested structured content, that
is not an entity by itself.</p>

<h1 id="soft-delete">Soft Delete</h1>

<p>We won't support soft-delete at all. If you want to implement a
soft-delete alike behaviour its probably a good idea to look into the
State pattern instead.</p>

<h1 id="blameable">Blameable</h1>

<p>Implementing this behaviour is just a matter of adding two fields
<em>createdByUserId</em> and <em>modifiedByUserId</em> fields and setting them
whenever one of your relevant fields change by hooking into setter
methods:</p>

<pre><code class="sourceCode php">&lt;?php
/**
 * @Entity
 */
class BlogPost
{
    /**
     * @Column(type="string")
     */
    private $title;

    /**
     * @Column(type="integer")
     */
    private $modifiedByUserId;

    public function updateBlogPost($title, ..., User $user)
    {
        $this-&gt;title = $title;
        $this-&gt;modifiedByUserId = $user-&gt;getId();
    }
}
</code></pre>

<h1 id="sortable">Sortable</h1>

<p>Same as I18N, we are planning to support persistence of collection keys
in the Doctrine 2 Core. This would allow to sort collections by using
the possibilities of the <code>Doctrine\Common\Collections\Collection</code>
interface.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Although slightly more complex than Doctrine 1s simple configuration
options, most "behaviours" are still way easy to implement in Doctrine
2. The additional benefit of this straightforward approach: <em>You can
combine behaviours in any way, inside your domain model, without having
to wonder how the magic works together, you are completly on top of it.</em></p>

        </div>

            </article>

    <nav class="mt-4">
        <ul class="pagination">
            <li class="page-item"><a class="page-link" href="https://www.doctrine-project.org/blog/page/51.html">Newer Posts</a></li><br />
            <li class="page-item"><a class="page-link" href="https://www.doctrine-project.org/blog/page/53.html">Older Posts</a></li>        </ul>
    </nav>
            </main>

        
        <button id="back-to-top" title="Go to top">Top</button>

        <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>

        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>

        <script src="https://www.doctrine-project.org/components/highlightjs/highlight.pack.js?3970aa"></script>

        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0"></script>

        <script id="instantsearch-template" type="text/template">
            
    <a href="{{url}}" class="list-group-item list-group-item-action flex-column align-items-start">
        <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{{_highlightResult.projectName.value}}}: {{{_highlightResult.h1.value}}}</h5>
        </div>

        {{#h2}}
            <p class="mb-1">
                <i class="far fa-arrow-alt-circle-right text-primary"></i>

                {{{_highlightResult.h2.value}}}

                {{#h3}}
                    > {{{_highlightResult.h3.value}}}
                {{/h3}}

                {{#h4}}
                    > {{{_highlightResult.h4.value}}}
                {{/h4}}

                {{#h5}}
                    > {{{_highlightResult.h5.value}}}
                {{/h5}}
            </p>
        {{/h2}}

        {{#content}}
            <div class="content p-2 rounded" style="background-color: rgba(0,0,0,.125);">
                {{{_highlightResult.content.value}}}
            </div>
        {{/content}}
    </a>

        </script>

        <script src="https://cdn.ravenjs.com/3.24.2/raven.min.js" crossorigin="anonymous"></script>

        <script type="text/javascript">
            Raven.config('https://09ce137590054cfd8f0b7e9324d6ec14@sentry.io/1197701').install()
        </script>

        <script src="https://www.doctrine-project.org/js/main.js?2a2af0"></script>
        <script src="https://www.doctrine-project.org/js/search.js?21d569"></script>

        <script type="text/javascript">
            var projectSlug = '';
            var versionSlug = 'latest';

            new Main();

            new Search(projectSlug, versionSlug);

            function googleAnalyticsEvent(eventCategory, eventAction, eventLabel, eventValue, fieldsObject) {
                                ga('send', 'event', eventCategory, eventAction, eventLabel, eventValue, fieldsObject);
                            }

            function googleTranslateElementInit() {
                $('#google_translate_element').html('');

                new google.translate.TranslateElement(
                    {pageLanguage: 'en'}, 'google_translate_element'
                );

                $('#google_translate_element select').on('change', function() {
                    var language = $('#google_translate_element select option:selected').text();

                    googleAnalyticsEvent('Translate', 'click', language);
                });
            }
        </script>

        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-7', 'auto');
                ga('send', 'pageview');
            </script>
        
        
            </body>
</html>
